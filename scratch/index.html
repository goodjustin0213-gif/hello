<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è»äººè·æ¶¯è–ªè³‡è¦åŠƒæ±ºç­–æ”¯æ´ç³»çµ± - å°‡å®˜èˆ‡æ™‚ç¨‹åŠ çµ¦ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body { background-color: #f7f9fc; }
        .scrollable-content { min-height: calc(100vh - 8rem); }
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>
    <header class="bg-indigo-900 text-white p-4 shadow-lg sticky top-0 z-10">
        <h1 class="text-2xl font-extrabold tracking-wide">ğŸš€ è»äººè·æ¶¯è²¡å‹™æ±ºç­–æ”¯æ´ç³»çµ±</h1>
        <p class="text-indigo-200 text-sm mt-1">é€²éšç‰ˆï¼šæ”¯æ´å°‡å®˜éšç´šèˆ‡éšæ®µæ€§åŠ çµ¦è¨­å®š</p>
    </header>

    <main class="flex flex-col lg:flex-row min-h-screen">
        <aside id="input-parameters" class="w-full lg:w-1/3 p-6 bg-white border-r border-gray-200 shadow-xl overflow-y-auto" style="max-height: 100vh;">
            <h2 class="text-xl font-bold mb-4 text-indigo-700">âš™ï¸ è²¡å‹™æ¨¡æ“¬åƒæ•¸è¨­å®š</h2>
            
            <div class="mb-5 border-b pb-4">
                <h3 class="font-semibold text-gray-700 mb-2">1. è»æ—…ç”Ÿæ¶¯å‡è¨­ (èµ·å§‹éšç´šå›ºå®šç‚ºå°‘å°‰ S2)</h3>
                
                <label for="targetRank" class="block text-sm font-medium text-gray-600">æœ€çµ‚ç›®æ¨™éšç´š (æœ€é«˜æ™‰å‡ä½éš)</label>
                <select id="targetRank" class="mt-1 block w-full border rounded-md py-2 px-3 bg-gray-50">
                    <option value="S2">å°‘å°‰ (S2)</option>
                    <option value="S3">ä¸­å°‰ (S3)</option>
                    <option value="S4">ä¸Šå°‰ (S4)</option>
                    <option value="M1">å°‘æ ¡ (M1)</option>
                    <option value="M2">ä¸­æ ¡ (M2)</option>
                    <option value="M3">ä¸Šæ ¡ (M3)</option>
                    <option value="G1" class="text-red-600 font-bold">å°‘å°‡ (G1)</option>
                    <option value="G2" class="text-red-600 font-bold">ä¸­å°‡ (G2)</option>
                    <option value="G3" class="text-red-600 font-bold">äºŒç´šä¸Šå°‡ (G3)</option>
                </select>
                
                <label for="serviceYears" class="block text-sm font-medium text-gray-600 mt-3">é è¨ˆæœå½¹ç¸½å¹´æ•¸ (10-35å¹´)</label>
                <input type="number" id="serviceYears" value="25" min="10" max="40" class="mt-1 block w-full border rounded-md py-2 px-3">
            </div>

            <div class="mb-5 border-b pb-4">
                <h3 class="font-semibold text-gray-700 mb-2">2. éšæ®µæ€§é¡å¤–åŠ çµ¦ (æœˆé¡)</h3>
                <p class="text-xs text-indigo-500 mb-2">è«‹è¨­å®šåŠ çµ¦é‡‘é¡åŠå…¶é ˜å–çš„ã€Œé–‹å§‹ã€èˆ‡ã€ŒçµæŸã€å¹´ä»½ã€‚</p>
                <p class="text-xs text-red-500 mb-2 font-bold">è¨»ï¼šå·²è‡ªå‹•åŒ…å«å¿—é¡˜å½¹åŠ çµ¦ NT$15,000 å…ƒ (å…¨æœŸ)ã€‚</p>
                
                <div class="grid grid-cols-12 gap-1 text-xs text-gray-500 mb-1 px-1">
                    <div class="col-span-4">é …ç›®åç¨±</div>
                    <div class="col-span-3">é‡‘é¡</div>
                    <div class="col-span-2 text-center">èµ·å§‹å¹´</div>
                    <div class="col-span-2 text-center">çµæŸå¹´</div>
                    <div class="col-span-1"></div>
                </div>

                <div id="custom-allowances-container" class="space-y-2 mt-1">
                </div>
                <button type="button" onclick="addCustomAllowance()" class="w-full bg-indigo-100 text-indigo-700 text-sm font-semibold py-2 mt-2 rounded-md hover:bg-indigo-200 transition duration-150 border border-indigo-200">
                    + æ–°å¢éšæ®µæ€§åŠ çµ¦ (ä¾‹å¦‚: ä¸»å®˜è·ã€å¤–å³¶)
                </button>
            </div>

            <div class="mb-5 border-b pb-4">
                <h3 class="font-semibold text-gray-700 mb-2">3. ç†è²¡ç­–ç•¥å‡è¨­ (å®šé¡åˆ¶)</h3>
                
                <label for="monthlySavings" class="block text-sm font-medium text-gray-600">æ¯æœˆå›ºå®šå„²è“„/æŠ•è³‡é‡‘é¡ (å…ƒ)</label>
                <input type="number" id="monthlySavings" value="20000" min="0" step="1000" class="mt-1 block w-full border rounded-md py-2 px-3 text-indigo-700 font-bold bg-indigo-50">
                
                <label for="returnRate" class="block text-sm font-medium text-gray-600 mt-3">å¹´åŒ–å¹³å‡æŠ•è³‡å ±é…¬ç‡å‡è¨­ (%)</label>
                <input type="number" id="returnRate" value="5" min="0" max="15" step="0.1" class="mt-1 block w-full border rounded-md py-2 px-3">
            </div>

            <div class="mb-5">
                <h3 class="font-semibold text-gray-700 mb-2">4. åŸºæœ¬ç”Ÿæ´»æ”¯å‡ºå‡è¨­</h3>
                <label for="livingCost" class="block text-sm font-medium text-gray-600">æ¯æœˆåŸºæœ¬ç”Ÿæ´»æ”¯å‡º (å…ƒ)</label>
                <input type="number" id="livingCost" value="15000" class="mt-1 block w-full border rounded-md py-2 px-3">
            </div>

            <button onclick="runSimulation()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-150 mb-8">
                ğŸš€ åŸ·è¡Œè²¡å‹™æ±ºç­–æ¨¡æ“¬
            </button>
            <p id="simulation-status" class="mt-4 text-center text-sm text-red-500 font-semibold hidden">
                è«‹å…ˆè¼¸å…¥åƒæ•¸ä¸¦é»æ“ŠæŒ‰éˆ•ã€‚
            </p>
        </aside>

        <section class="w-full lg:w-2/3 p-6 scrollable-content">
            
            <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white p-5 rounded-lg shadow-md border-t-4 border-indigo-500">
                    <p class="text-sm text-gray-500">é è¨ˆæœå½¹æœŸç¸½è³‡ç”¢ç´¯ç©</p>
                    <p id="total-asset" class="text-3xl font-extrabold text-indigo-800 mt-1">--</p>
                    <p class="text-xs text-gray-400 mt-1">å„²è“„èˆ‡æŠ•è³‡è¤‡åˆ©æˆæœ</p>
                </div>
                <div class="bg-white p-5 rounded-lg shadow-md border-t-4 border-orange-500">
                    <p class="text-sm text-gray-500">æœå½¹æœŸé–“å¹³å‡æœˆæ·¨ç¾é‡‘æµ</p>
                    <p id="avg-cashflow" class="text-3xl font-extrabold text-orange-800 mt-1">--</p>
                    <p class="text-xs text-gray-400 mt-1">æ‰£é™¤æ”¯å‡ºèˆ‡å›ºå®šæŠ•è³‡å¾Œçš„é¤˜è£•</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-bold text-gray-700 mb-4">ğŸ“ˆ è–ªè³‡æˆé•·èˆ‡è³‡ç”¢ç´¯ç©èµ°å‹¢åœ–</h2>
                <canvas id="financialChart"></canvas>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-gray-700 mb-4">ğŸ’° ä¸åŒæŠ•è³‡ç­–ç•¥ä¸‹çš„è³‡ç”¢æƒ…å¢ƒæ¯”è¼ƒ</h2>
                <canvas id="scenarioChart"></canvas>
            </div>

        </section>
    </main>
    
    <script>
        // =========================================================
        // DATA SOURCE: 114å¹´1æœˆ1æ—¥ç”Ÿæ•ˆ å¿—é¡˜å½¹ç¾å½¹è»äººä¿¸é¡è¡¨
        // =========================================================
        // è¨»ï¼šå°‡ç´šè»å®˜è³‡æ–™å¼•ç”¨è‡ª ï¼Œå°ˆæ¥­åŠ çµ¦å› è³‡æ–™ç¼ºä¹æš«ä»¥é ä¼°å€¼è¨­å®š
        const REAL_SALARY_STRUCTURE = {
            'S2': { rank: 'å°‘å°‰', base: 22750, pro_add: 28000, food_add: 2840, promotion_years: 3, annual_growth: 0.015 },
            'S3': { rank: 'ä¸­å°‰', base: 25050, pro_add: 30000, food_add: 2840, promotion_years: 4, annual_growth: 0.015 },
            'S4': { rank: 'ä¸Šå°‰', base: 28880, pro_add: 35000, food_add: 2840, promotion_years: 7, annual_growth: 0.015 },
            'M1': { rank: 'å°‘æ ¡', base: 32710, pro_add: 45000, food_add: 2840, promotion_years: 6, annual_growth: 0.015 },
            'M2': { rank: 'ä¸­æ ¡', base: 37310, pro_add: 55000, food_add: 2840, promotion_years: 6, annual_growth: 0.015 },
            'M3': { rank: 'ä¸Šæ ¡', base: 41900, pro_add: 65000, food_add: 2840, promotion_years: 6, annual_growth: 0.015 }, // ä¿®æ”¹ä¸Šæ ¡æœ€å¿«6å¹´
            // æ–°å¢å°‡å®˜éšç´š (æœ¬ä¿¸ä¾†æº: Source 2ï¼Œå°ˆæ¥­åŠ çµ¦: é ä¼°)
            'G1': { rank: 'å°‘å°‡', base: 48030, pro_add: 70000, food_add: 2840, promotion_years: 4, annual_growth: 0.01 },
            'G2': { rank: 'ä¸­å°‡', base: 53390, pro_add: 80000, food_add: 2840, promotion_years: 3, annual_growth: 0.01 },
            'G3': { rank: 'äºŒç´šä¸Šå°‡', base: 109520, pro_add: 90000, food_add: 2840, promotion_years: Infinity, annual_growth: 0.01 }
        };

        const RANK_ORDER = ['S2', 'S3', 'S4', 'M1', 'M2', 'M3', 'G1', 'G2', 'G3'];
        
        // å¿—é¡˜å½¹äººå“¡å›ºå®šåŠ çµ¦ (NT$15,000)
        const VOLUNTEER_ADDITION_2026 = 15000;
        
        // åœ‹è»é€€æ’«åŸºé‡‘ææ’¥ç‡ (å‡è¨­ 14%ï¼Œå…¶ä¸­å€‹äººè² æ“” 35%)
        const PENSION_RATE = 0.14; 
        const INDIVIDUAL_PENSION_RATIO = 0.35; 

        let financialChartInstance;
        let scenarioChartInstance;
        let allowanceCounter = 0;

        // --- è¼”åŠ©å‡½æ•¸ ---

        function formatCurrency(number) {
            if (isNaN(number) || number === 0) return '--';
            const absNum = Math.abs(Math.round(number));
            const sign = number < 0 ? "-" : "";
            return `${sign}NT$ ${absNum.toLocaleString('zh-TW')}`;
        }

        /**
         * æ–°å¢ä¸€çµ„è‡ªè¨‚åŠ çµ¦è¼¸å…¥æ¡† (åç¨± + é‡‘é¡ + èµ·å§‹å¹´ + çµæŸå¹´)
         */
        function addCustomAllowance() {
            allowanceCounter++;
            const container = document.getElementById('custom-allowances-container');
            const itemId = `custom-item-${allowanceCounter}`;
            const maxYears = document.getElementById('serviceYears').value;

            // ç¯„ä¾‹é è¨­å€¼
            let defaultName = "";
            let defaultValue = 0;
            let defaultStart = 1;
            let defaultEnd = maxYears;
            
            if (allowanceCounter === 1 && container.children.length === 0) {
                defaultName = "å¤–å³¶åŠ çµ¦ (ç¯„ä¾‹)";
                defaultValue = 9790;
                defaultStart = 1;
                defaultEnd = 3; // å‡è¨­åªå»3å¹´
            }

            const newAllowanceHtml = `
                <div id="${itemId}" class="grid grid-cols-12 gap-1 items-center allowance-row mb-2">
                    <div class="col-span-4">
                        <input type="text" placeholder="é …ç›®" value="${defaultName}" class="w-full border rounded-md py-1 px-2 text-sm allow-name" oninput="runSimulation()">
                    </div>
                    <div class="col-span-3">
                        <input type="number" placeholder="é‡‘é¡" value="${defaultValue}" class="w-full border rounded-md py-1 px-2 text-sm allow-value" oninput="runSimulation()">
                    </div>
                    <div class="col-span-2">
                        <input type="number" placeholder="å§‹" value="${defaultStart}" min="1" class="w-full border rounded-md py-1 px-1 text-sm text-center allow-start" oninput="runSimulation()">
                    </div>
                    <div class="col-span-2">
                        <input type="number" placeholder="æœ«" value="${defaultEnd}" min="1" class="w-full border rounded-md py-1 px-1 text-sm text-center allow-end" oninput="runSimulation()">
                    </div>
                    <div class="col-span-1 text-center">
                        <button type="button" onclick="document.getElementById('${itemId}').remove(); runSimulation();" class="text-red-500 hover:text-red-700 font-bold text-lg">
                            &times;
                        </button>
                    </div>
                </div>
            `;
            // ä½¿ç”¨ insertAdjacentHTML é¿å…ç ´å£ç¾æœ‰è¼¸å…¥æ¡†çš„ç‹€æ…‹
            container.insertAdjacentHTML('beforeend', newAllowanceHtml);
        }

        /**
         * ç²å–æ‰€æœ‰è‡ªè¨‚åŠ çµ¦çš„è¨­å®š (å›å‚³é™£åˆ—)
         */
        function getCustomAllowancesConfig() {
            const rows = document.querySelectorAll('.allowance-row');
            const configs = [];
            
            rows.forEach(row => {
                const amount = parseInt(row.querySelector('.allow-value').value) || 0;
                const start = parseInt(row.querySelector('.allow-start').value) || 1;
                const end = parseInt(row.querySelector('.allow-end').value) || 100;
                
                if (amount > 0) {
                    configs.push({ amount, start, end });
                }
            });
            return configs;
        }

        /**
         * è¨ˆç®—æŸä¸€å¹´åº¦çš„é¡å¤–åŠ çµ¦ç¸½å’Œ
         */
        function calculateYearlyAllowance(year, allowanceConfigs) {
            let total = 0;
            allowanceConfigs.forEach(config => {
                if (year >= config.start && year <= config.end) {
                    total += config.amount;
                }
            });
            return total;
        }

        /**
         * æ ¹æ“šéšç´šã€å¹´è³‡ã€åŠã€Œè©²å¹´åº¦ã€çš„è‡ªè¨‚æ´¥è²¼è¨ˆç®—ç•¶å‰æœˆè–ªç¸½é¡
         */
        function calculateMonthlySalary(rankCode, year, currentYearAllowance) {
            const data = REAL_SALARY_STRUCTURE[rankCode];
            if (!data) return 0;
            
            const pensionBase = data.base + data.pro_add;
            
            // ç¨…å‰ç¸½æ”¶å…¥ (æœ¬ä¿¸ + å°ˆæ¥­ + ä¼™é£Ÿ + å¿—é¡˜å½¹1.5è¬ + è©²å¹´è‡ªè¨‚åŠ çµ¦)
            let monthlyTotal = pensionBase + data.food_add + VOLUNTEER_ADDITION_2026 + currentYearAllowance;
            
            // è€ƒæ…®å¹´åº¦åŸºç¤æˆé•·
            monthlyTotal *= (1 + data.annual_growth) ** (year - 1);
            
            // æ‰£é™¤é€€æ’« (åŸºæº–ä¹Ÿéš¨å¹´è³‡æˆé•·)
            const actualPensionDeduction = pensionBase * PENSION_RATE * INDIVIDUAL_PENSION_RATIO * ((1 + data.annual_growth) ** (year - 1));

            return Math.round(monthlyTotal - actualPensionDeduction);
        }

        function renderFinancialChart(years, salaryData, assetData) {
            if (financialChartInstance) financialChartInstance.destroy();
            const ctx = document.getElementById('financialChart').getContext('2d');
            financialChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'æ¯æœˆæ·¨è–ªè³‡ (å«åŠ çµ¦)', 
                            data: salaryData,
                            borderColor: 'rgb(79, 70, 229)', yAxisID: 'y1', fill: false, tension: 0.1
                        },
                        {
                            label: 'ç´¯ç©è³‡ç”¢',
                            data: assetData,
                            borderColor: 'rgb(20, 184, 166)', yAxisID: 'y2', fill: true, backgroundColor: 'rgba(20, 184, 166, 0.2)', tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y1: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'æœˆæ·¨è–ªè³‡ (å…ƒ)' } },
                        y2: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'ç´¯ç©è³‡ç”¢ (å…ƒ)' }, grid: { drawOnChartArea: false } }
                    },
                }
            });
        }

        function renderScenarioChart(years, baseSalaryData, livingCost, monthlySavings) {
            if (scenarioChartInstance) scenarioChartInstance.destroy();
            const lowRate = 0.02; const highRate = 0.08;
            const baseRate = parseFloat(document.getElementById('returnRate').value) / 100 || 0;

            const calcScenarioAsset = (rate) => {
                let asset = 0;
                const data = [];
                for (let i = 0; i < baseSalaryData.length; i++) {
                    asset = asset * (1 + rate) + (monthlySavings * 12);
                    data.push(asset);
                }
                return data;
            };
            
            const baseAsset = calcScenarioAsset(baseRate);
            const lowAsset = calcScenarioAsset(lowRate);
            const highAsset = calcScenarioAsset(highRate); 

            const ctx = document.getElementById('scenarioChart').getContext('2d');
            scenarioChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        { label: `ä½é¢¨éšª (${lowRate * 100}%)`, data: lowAsset, borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255, 99, 132, 0.5)', tension: 0.2 },
                        { label: `æ‚¨çš„è¨­å®š (${baseRate * 100}%)`, data: baseAsset, borderColor: 'rgb(54, 162, 235)', backgroundColor: 'rgba(54, 162, 235, 0.5)', borderWidth: 3, tension: 0.2 },
                        { label: `é«˜é¢¨éšª (${highRate * 100}%)`, data: highAsset, borderColor: 'rgb(75, 192, 192)', backgroundColor: 'rgba(75, 192, 192, 0.5)', tension: 0.2 }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: { y: { title: { display: true, text: 'ç´¯ç©è³‡ç”¢ (å…ƒ)' } } }
                }
            });
        }

        function runSimulation() {
            const targetRank = document.getElementById('targetRank').value;
            const serviceYears = parseInt(document.getElementById('serviceYears').value) || 0;
            const monthlySavings = parseInt(document.getElementById('monthlySavings').value) || 0;
            const returnRate = parseFloat(document.getElementById('returnRate').value) / 100 || 0;
            const livingCost = parseInt(document.getElementById('livingCost').value) || 0;
            
            // 1. å–å¾—æ‰€æœ‰åŠ çµ¦çš„è¨­å®š (é™£åˆ—)
            const allowanceConfigs = getCustomAllowancesConfig();
            
            if (serviceYears < 10 || isNaN(serviceYears)) {
                return; // åŸºæœ¬éŒ¯èª¤æª¢æŸ¥
            }

            let currentAsset = 0;
            let currentRank = 'S2'; 
            let yearOfRank = 0; 
            let totalCashFlow = 0;
            
            const years = [];
            const monthlySalaryData = [];
            const totalAssetData = [];
            const targetRankIndex = RANK_ORDER.indexOf(targetRank);

            for (let year = 1; year <= serviceYears; year++) {
                years.push(`ç¬¬ ${year} å¹´`);

                // 2. æ™‰å‡é‚è¼¯
                const currentRankData = REAL_SALARY_STRUCTURE[currentRank];
                const currentIndex = RANK_ORDER.indexOf(currentRank);
                
                if (yearOfRank >= currentRankData.promotion_years && currentIndex < targetRankIndex) {
                    const nextRankIndex = currentIndex + 1;
                    if (nextRankIndex <= targetRankIndex) { 
                        currentRank = RANK_ORDER[nextRankIndex];
                        yearOfRank = 0; 
                    }
                }
                
                // 3. è¨ˆç®—è©²å¹´åº¦é©ç”¨çš„åŠ çµ¦ç¸½é¡
                const currentYearAllowance = calculateYearlyAllowance(year, allowanceConfigs);

                // 4. è¨ˆç®—æœˆè–ª
                let monthlySalary = calculateMonthlySalary(currentRank, year, currentYearAllowance);
                monthlySalaryData.push(monthlySalary);

                // 5. è²¡å‹™è¨ˆç®— (å®šé¡å„²è“„åˆ¶)
                const annualSalary = monthlySalary * 12;
                const annualLivingCost = livingCost * 12;
                const annualSavingsInvestment = monthlySavings * 12;
                const annualNetIncome = annualSalary - annualLivingCost;
                const annualRemainingCash = annualNetIncome - annualSavingsInvestment;
                
                totalCashFlow += annualRemainingCash;
                currentAsset = currentAsset * (1 + returnRate) + annualSavingsInvestment;
                totalAssetData.push(currentAsset);
                
                yearOfRank++; 
            }

            const finalAsset = totalAssetData[totalAssetData.length - 1] || 0;
            const avgMonthlyCashFlow = totalCashFlow / serviceYears / 12 || 0;
            
            document.getElementById('total-asset').innerText = formatCurrency(finalAsset);
            document.getElementById('avg-cashflow').innerText = formatCurrency(avgMonthlyCashFlow);
            
            renderFinancialChart(years, monthlySalaryData, totalAssetData);
            renderScenarioChart(years, monthlySalaryData, livingCost, monthlySavings);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('custom-allowances-container');
            if (container.children.length === 0) {
                addCustomAllowance(); // é è¨­æ–°å¢ä¸€ç­†
            }
            
            // ç¶å®šè¼¸å…¥äº‹ä»¶
            document.querySelectorAll('#input-parameters input, #input-parameters select').forEach(element => {
                element.addEventListener('change', runSimulation);
                element.addEventListener('input', runSimulation);
            });

            runSimulation();
        });
    </script>
</body>
</html>
