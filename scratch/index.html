<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國軍財務戰情室 v27.0 (教授指導修正版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        /* 基礎設定 */
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #38bdf8; --danger: #f43f5e; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); color: #cbd5e1; height: 100vh; overflow: hidden; display: flex; margin: 0; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* 側邊欄 */
        aside { width: 380px; background: #0b1121; border-right: 1px solid #1e293b; display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; }
        .input-group { background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid #334155; margin-bottom: 12px; }
        label { font-size: 0.75rem; color: #94a3b8; display: block; margin-bottom: 5px; font-weight: 700; }
        input, select { background: #0f172a; border: 1px solid #334155; color: white; padding: 6px; border-radius: 4px; width: 100%; font-family: 'JetBrains Mono'; font-size: 0.9rem; }
        
        /* 按鈕與切換 */
        .tab-box { display: flex; gap: 5px; background: #0f172a; padding: 4px; border-radius: 6px; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 8px; text-align: center; cursor: pointer; color: #64748b; font-weight: bold; border-radius: 4px; font-size: 0.85rem; transition: 0.2s; }
        .tab-btn.active { background: #334155; color: var(--accent); border: 1px solid #475569; }
        
        .tier-btn { flex: 1; background: #0f172a; border: 1px solid #334155; color: #64748b; padding: 5px; font-size: 0.7rem; cursor: pointer; text-align: center; border-radius: 4px; }
        .tier-btn:hover { background: #334155; }
        
        /* 主畫面 */
        main { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: rgba(30, 41, 59, 0.5); border-left: 4px solid #334155; padding: 15px; border-radius: 6px; }
        .kpi-val { font-family: 'JetBrains Mono'; font-size: 1.5rem; font-weight: bold; color: #fff; }
        .chart-container { height: 300px; background: rgba(30, 41, 59, 0.3); border-radius: 8px; padding: 10px; margin-bottom: 15px; border: 1px solid #334155; }
        
        /* 表格 */
        .data-table { width: 100%; font-size: 0.75rem; border-collapse: collapse; }
        .data-table th { text-align: right; padding: 8px; color: #64748b; border-bottom: 1px solid #334155; }
        .data-table td { text-align: right; padding: 8px; border-bottom: 1px solid #1e293b; font-family: 'JetBrains Mono'; }
        .data-table tr:hover { background: #1e293b; }

        /* 警示框 */
        #budget-alert { padding: 10px; margin-bottom: 15px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; text-align: center; display: none; }
    </style>
</head>
<body>

<aside>
    <div class="p-5 border-b border-slate-800 bg-slate-950">
        <h1 class="text-lg font-bold text-white">國軍財務戰情室 <span class="text-xs text-cyan-500">v27.0</span></h1>
        <p class="text-xs text-slate-500 mt-1">教授指導修正版 (GitHub Ready)</p>
    </div>

    <div class="p-4">
        <div class="tab-box">
            <div id="tab-A" class="tab-btn active" onclick="APP.switchTab('A')">方案 A (現狀)</div>
            <div id="tab-B" class="tab-btn" onclick="APP.switchTab('B')">方案 B (優化)</div>
        </div>

        <div class="input-group">
            <label class="text-cyan-400">CAREER // 職涯與薪資</label>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <select id="currentRank" onchange="APP.update()"></select>
                <select id="targetRank" onchange="APP.update()"></select>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div><label>服役年數</label><input type="number" id="years" value="20" oninput="APP.update()"></div>
                <div><label>實領校正</label><input type="number" id="realPay" value="0" placeholder="0為自動" oninput="APP.update()"></div>
            </div>
        </div>

        <div class="input-group">
            <label class="text-rose-400">LIFESTYLE // 消費分級</label>
            <div class="flex gap-1 mb-2">
                <div class="tier-btn" onclick="APP.setLiving(30)">節約 (30%)</div>
                <div class="tier-btn" onclick="APP.setLiving(50)">一般 (50%)</div>
                <div class="tier-btn" onclick="APP.setLiving(70)">享樂 (70%)</div>
            </div>
            <div class="flex justify-between mb-1"><span class="text-xs">支出佔比</span><span id="livingPctLabel" class="text-xs text-white">50%</span></div>
            <input type="range" id="livingPct" min="10" max="90" value="50" oninput="APP.updateInput('livingPct')">
            
            <label class="mt-2">剛性支出 (保險/孝親)</label>
            <input type="number" id="fixedCost" value="5000" oninput="APP.update()">
        </div>

        <div class="input-group">
            <label class="text-emerald-400">ASSETS // 投資置產</label>
            <div class="flex justify-between mb-1"><span class="text-xs">月薪提撥率</span><span id="investRateLabel" class="text-xs text-white">30%</span></div>
            <input type="range" id="investRate" min="0" max="80" value="30" oninput="APP.updateInput('investRate')">
            
            <div class="grid grid-cols-2 gap-2 mt-2 mb-2">
                <div><label>年報酬(%)</label><input type="number" id="roi" value="6.0" oninput="APP.update()"></div>
                <div><label>通膨率(%)</label><input type="number" id="inflation" value="2.0" oninput="APP.update()"></div>
            </div>

            <div class="border-t border-slate-700 pt-2 mt-2">
                <div class="flex justify-between items-center mb-2">
                    <label class="mb-0 text-orange-400">購屋模擬</label>
                    <input type="checkbox" id="buyHouse" class="w-4 h-4" onchange="APP.update()">
                </div>
                <div id="housing-area" class="hidden grid grid-cols-2 gap-2">
                    <input type="number" id="buyYear" value="10" placeholder="第N年買">
                    <input type="number" id="housePrice" value="1200" placeholder="總價(萬)">
                    <input type="number" id="downPayment" value="20" placeholder="頭期%">
                    <input type="number" id="loanYears" value="30" placeholder="年限">
                </div>
            </div>
        </div>
    </div>
</aside>

<main>
    <div id="budget-alert"></div>

    <div class="kpi-grid">
        <div class="kpi-card" style="border-color: #38bdf8;">
            <div class="text-xs text-slate-400 mb-1">Plan A 淨資產</div>
            <div class="kpi-val text-cyan-400" id="kpi-A">--</div>
        </div>
        <div class="kpi-card" style="border-color: #10b981;">
            <div class="text-xs text-slate-400 mb-1">Plan B 淨資產</div>
            <div class="kpi-val text-emerald-400" id="kpi-B">--</div>
        </div>
        <div class="kpi-card" style="border-color: #f59e0b;">
            <div class="text-xs text-slate-400 mb-1">效益差額 (Alpha)</div>
            <div class="kpi-val text-amber-400" id="kpi-diff">--</div>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
        <div class="chart-container">
            <canvas id="chart-asset"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="chart-wealth"></canvas>
        </div>
    </div>

    <div class="flex-1 overflow-auto bg-slate-900/50 rounded p-0 border border-slate-800">
        <table class="data-table">
            <thead class="bg-slate-900 sticky top-0">
                <tr>
                    <th style="text-align:center">年次</th>
                    <th style="text-align:left">階級</th>
                    <th>年總收</th>
                    <th style="color:#f43f5e">年總支</th>
                    <th style="color:#10b981">投資額</th>
                    <th style="color:#f59e0b">房貸/頭期</th>
                    <th style="color:#fff">淨資產</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</main>

<script>
/**
 * 國軍財務戰情室 v27.0 Core Logic
 * 包含：生活通膨係數、退伍金一次領、資產變現機制、預算審計
 */
Chart.defaults.color = '#64748b';
Chart.defaults.borderColor = '#1e293b';

const APP = {
    currentTab: 'A',
    store: { A: {}, B: {} },
    charts: {},
    
    // 薪資參考 (本俸+專業)
    rankData: {
        '二兵': {b:10550, p:0}, '一兵': {b:11130, p:0}, '上兵': {b:12280, p:0},
        '下士': {b:14645, p:5500}, '中士': {b:16585, p:6200}, '上士': {b:18525, p:7000},
        '三等士官長': {b:22750, p:8200}, '二等士官長': {b:25050, p:9500}, '一等士官長': {b:28880, p:10800},
        '少尉': {b:22750, p:8500}, '中尉': {b:25050, p:9800}, '上尉': {b:28880, p:11500},
        '少校': {b:32710, p:23000}, '中校': {b:37310, p:26000}, '上校': {b:41900, p:32000}
    },
    ranks: ['二兵','一兵','上兵','下士','中士','上士','三等士官長','二等士官長','一等士官長','少尉','中尉','上尉','少校','中校','上校'],

    // 工具
    N: v => parseFloat(String(v).replace(/,/g,'')) || 0,
    F: n => Math.round(n).toLocaleString('en-US'),

    init: () => {
        // 生成階級選單
        const opts = APP.ranks.map(r => `<option value="${r}">${r}</option>`).join('');
        document.getElementById('currentRank').innerHTML = opts;
        document.getElementById('targetRank').innerHTML = opts;

        // 初始化 A/B 兩案
        const def = {
            cRank:'少尉', tRank:'中校', years:20, realPay:0,
            livingPct: 50, fixed: 5000, 
            rate: 10, roi: 2.0, inf: 2.0, // A案：保守定存
            buyHouse:false, buyY:10, hPrice:1200, down:20, loanY:30
        };
        
        APP.store.A = JSON.parse(JSON.stringify(def));
        
        APP.store.B = JSON.parse(JSON.stringify(def));
        APP.store.B.livingPct = 30; // B案：節約
        APP.store.B.rate = 40;      // B案：高儲蓄
        APP.store.B.roi = 6.0;      // B案：指數投資

        APP.loadToUI('A');
        APP.update();
    },

    switchTab: (tab) => {
        APP.saveFromUI(APP.currentTab);
        APP.currentTab = tab;
        APP.loadToUI(tab);
        APP.update();
    },

    setLiving: (val) => {
        document.getElementById('livingPct').value = val;
        APP.updateInput('livingPct');
    },

    updateInput: (id) => {
        document.getElementById(id + 'Label').innerText = document.getElementById(id).value + '%';
        APP.update();
    },

    saveFromUI: (tab) => {
        const d = APP.store[tab];
        d.cRank = document.getElementById('currentRank').value;
        d.tRank = document.getElementById('targetRank').value;
        d.years = APP.N(document.getElementById('years').value);
        d.realPay = APP.N(document.getElementById('realPay').value);
        d.livingPct = APP.N(document.getElementById('livingPct').value);
        d.fixed = APP.N(document.getElementById('fixedCost').value);
        d.rate = APP.N(document.getElementById('investRate').value);
        d.roi = APP.N(document.getElementById('roi').value);
        d.inf = APP.N(document.getElementById('inflation').value);
        d.buyHouse = document.getElementById('buyHouse').checked;
        if(d.buyHouse) {
            d.buyY = APP.N(document.getElementById('buyYear').value);
            d.hPrice = APP.N(document.getElementById('housePrice').value);
            d.down = APP.N(document.getElementById('downPayment').value);
            d.loanY = APP.N(document.getElementById('loanYears').value);
        }
    },

    loadToUI: (tab) => {
        const d = APP.store[tab];
        document.getElementById('currentRank').value = d.cRank;
        document.getElementById('targetRank').value = d.tRank;
        document.getElementById('years').value = d.years;
        document.getElementById('realPay').value = d.realPay;
        document.getElementById('livingPct').value = d.livingPct;
        document.getElementById('livingPctLabel').innerText = d.livingPct + '%';
        document.getElementById('fixedCost').value = d.fixed;
        document.getElementById('investRate').value = d.rate;
        document.getElementById('investRateLabel').innerText = d.rate + '%';
        document.getElementById('roi').value = d.roi;
        document.getElementById('inflation').value = d.inf;
        document.getElementById('buyHouse').checked = d.buyHouse;
        document.getElementById('buyYear').value = d.buyY;
        document.getElementById('housePrice').value = d.hPrice;
        document.getElementById('downPayment').value = d.down;
        document.getElementById('loanYears').value = d.loanY;

        document.getElementById('tab-A').className = `tab-btn ${tab==='A'?'active':''}`;
        document.getElementById('tab-B').className = `tab-btn ${tab==='B'?'active':''}`;
        document.getElementById('housing-area').className = d.buyHouse ? 'grid grid-cols-2 gap-2' : 'hidden';
    },

    // --- 核心計算引擎 ---
    calculateScenario: (d) => {
        const years = d.years || 20;
        const roi = d.roi / 100;
        const inf = d.inf / 100;
        
        let inv = 0, cash = 0, hasHouse = false, houseVal = 0, loan = 0;
        let cIdx = APP.ranks.indexOf(d.cRank);
        let tIdx = APP.ranks.indexOf(d.tRank);
        let yrInR = 0;
        let hasError = false;

        const res = { years:[], net:[], inv:[], cash:[], house:[], logs:[], hasError: false };

        for(let y=1; y<=years; y++) {
            // 1. 晉升邏輯
            if (y > 1 && y % 4 === 0 && cIdx < tIdx) { cIdx++; yrInR = 0; } else yrInR++;
            let rName = APP.ranks[cIdx];
            const rInfo = APP.rankData[rName];

            // 2. 收入計算
            let mPay = d.realPay > 0 ? d.realPay * Math.pow(1.015, y-1) : (rInfo.b * Math.pow(1.015, yrInR) + rInfo.p + 15000);
            let aInc = mPay * 13.5;

            // [教授要求] 退伍金挹注
            if (y === years && years >= 20) {
                const pension = mPay * (100 + cIdx * 5) * 0.45; // 概算
                aInc += pension;
                rName += " (退伍金)";
            }

            // [教授要求] 生活通膨 (Creep)
            const creep = 1 + (cIdx * 0.04); // 階級每升一級，生活費加權增加 4%
            const mLiving = (mPay * (d.livingPct / 100)) * creep;
            const aExp = (mLiving + d.fixed) * 12 * Math.pow(1 + inf, y-1);

            // 3. 房產與資產變現
            let mort = 0, downPay = 0;
            if (d.buyHouse && y === d.buyY && !hasHouse) {
                hasHouse = true; houseVal = d.hPrice * 10000;
                downPay = houseVal * (d.down/100);
                loan = houseVal - downPay;
                
                // [教授要求] 資產變現邏輯 (現金不夠賣股票)
                if (cash >= downPay) cash -= downPay;
                else { 
                    const diff = downPay - cash;
                    cash = 0; 
                    inv -= diff; // 扣除投資
                }
            }
            if (hasHouse && loan > 0) {
                const r = 0.022/12, n = d.loanY * 12;
                const pmt = loan * r * Math.pow(1+r, n) / (Math.pow(1+r, n) - 1);
                mort = pmt * 12;
                loan -= (mort - loan * 0.022);
                if (loan < 0) loan = 0;
            }

            const aInv = (mPay * (d.rate / 100) * 12);

            // [教授要求] 紅字預警 (收支審計)
            // 檢查：支出 + 投資 + 房貸 是否大於 收入
            if ((aExp + aInv + mort + downPay) > aInc) {
                // 如果現金和投資都不夠抵扣，才是真正的破產錯誤
                if (cash + inv + (aInc - aExp - aInv - mort - downPay) < 0) hasError = true;
            }

            // 4. 結餘滾存
            const surplus = aInc - aExp - aInv - mort;
            inv = inv * (1 + roi) + aInv;
            cash += surplus;

            const hNet = hasHouse ? Math.max(0, houseVal - loan) : 0;
            const net = inv + cash + hNet;

            res.years.push(y); res.net.push(net); res.inv.push(inv); res.cash.push(cash); res.house.push(hNet);
            res.logs.push({ y, rank: rName, inc: aInc, exp: aExp, inv: aInv, mort: mort+downPay, net });
        }
        res.hasError = hasError;
        return res;
    },

    update: () => {
        APP.saveFromUI(APP.currentTab);
        const rA = APP.calculateScenario(APP.store.A);
        const rB = APP.calculateScenario(APP.store.B);
        
        document.getElementById('kpi-A').innerText = APP.F(rA.net[rA.net.length-1]);
        document.getElementById('kpi-B').innerText = APP.F(rB.net[rB.net.length-1]);
        document.getElementById('kpi-diff').innerText = APP.F(rB.net[rB.net.length-1] - rA.net[rA.net.length-1]);

        // 警示控制
        const curr = APP.currentTab === 'A' ? rA : rB;
        const alertBox = document.getElementById('budget-alert');
        if(curr.hasError) {
            alertBox.style.display = 'block';
            alertBox.style.backgroundColor = 'rgba(244, 63, 94, 0.2)';
            alertBox.style.color = '#f43f5e';
            alertBox.style.border = '1px solid #f43f5e';
            alertBox.innerText = "⚠️ 嚴重警告：此方案出現財務赤字 (支出>收入)，請降低消費或投資比例！";
        } else {
            alertBox.style.display = 'block';
            alertBox.style.backgroundColor = 'rgba(16, 185, 129, 0.2)';
            alertBox.style.color = '#10b981';
            alertBox.style.border = '1px solid #10b981';
            alertBox.innerText = "✅ 財務健康：各年度收支平衡。";
        }

        APP.drawCharts(rA, rB);
        
        const tb = document.getElementById('table-body'); tb.innerHTML = '';
        curr.logs.forEach(l => {
            tb.innerHTML += `<tr>
                <td style="text-align:center">Y${l.y}</td>
                <td style="text-align:left; font-weight:bold">${l.rank}</td>
                <td style="color:#38bdf8">${APP.F(l.inc)}</td>
                <td style="color:#f43f5e">${APP.F(l.exp)}</td>
                <td style="color:#10b981">${APP.F(l.inv)}</td>
                <td style="color:#f59e0b">${APP.F(l.mort)}</td>
                <td style="color:#fff; font-weight:bold">${APP.F(l.net)}</td>
            </tr>`;
        });
    },

    drawCharts: (rA, rB) => {
        const labels = rA.years.map(y => 'Y'+y);
        const curr = APP.currentTab === 'A' ? rA : rB;

        // Chart 1: Line
        const ctx1 = document.getElementById('chart-asset').getContext('2d');
        if(APP.charts.asset) APP.charts.asset.destroy();
        APP.charts.asset = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: '方案 A', data: rA.net, borderColor: '#38bdf8', borderWidth:2, tension:0.3 },
                    { label: '方案 B', data: rB.net, borderColor: '#10b981', borderWidth:2, tension:0.3 }
                ]
            }, options: { responsive:true, maintainAspectRatio:false }
        });

        // Chart 2: Stacked Bar
        const ctx2 = document.getElementById('chart-wealth').getContext('2d');
        if(APP.charts.wealth) APP.charts.wealth.destroy();
        APP.charts.wealth = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: '金融資產', data: curr.inv, backgroundColor: '#10b981' },
                    { label: '現金', data: curr.cash, backgroundColor: '#3b82f6' },
                    { label: '房產淨值', data: curr.house, backgroundColor: '#f97316' }
                ]
            }, options: { responsive:true, maintainAspectRatio:false, scales: { x:{stacked:true}, y:{stacked:true} } }
        });
    }
};

window.onload = APP.init;
</script>
</body>
</html>
