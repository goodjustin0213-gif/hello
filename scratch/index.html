<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹è»è·æ¶¯å…¨æ–¹ä½æ±ºç­–ç³»çµ± (å«çé‡‘/é€€ä¼/çµ‚èº«ä¿¸/äººç”Ÿå¤§äº‹)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body { background-color: #f0f4f8; }
        .scrollable-content { height: calc(100vh - 5rem); overflow-y: auto; }
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        /* è‡ªå®šç¾©æ²è»¸ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7cc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1aa; }
    </style>
</head>
<body class="overflow-hidden">
    <header class="bg-slate-900 text-white p-4 shadow-lg flex justify-between items-center z-20 relative">
        <div>
            <h1 class="text-2xl font-extrabold tracking-wide flex items-center gap-2">
                ğŸ›¡ï¸ åœ‹è»è·æ¶¯å…¨æ–¹ä½æ±ºç­–ç³»çµ± 
                <span class="text-xs bg-yellow-500 text-black px-2 py-1 rounded-full">æ——è‰¦ç‰ˆ</span>
            </h1>
            <p class="text-slate-300 text-xs mt-1">æ•´åˆçé‡‘ã€å¼·åˆ¶é€€ä¼å¹´é™ã€çµ‚èº«ä¿¸è©¦ç®—èˆ‡äººç”Ÿå¤§äº‹æ¨¡æ“¬</p>
        </div>
        <div class="text-right text-xs text-slate-400">
            <p>2025 æ–°åˆ¶ä¿¸é¡è¡¨</p>
            <p>é€€æ’«æ–°åˆ¶åƒæ•¸</p>
        </div>
    </header>

    <main class="flex flex-col lg:flex-row h-screen pt-0">
        
        <aside id="input-parameters" class="w-full lg:w-1/3 bg-white border-r border-gray-200 shadow-2xl overflow-y-auto scrollable-content pb-20">
            <div class="p-6 space-y-6">
                
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-3 flex items-center">
                        <span class="bg-indigo-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">1</span> 
                        è·æ¶¯ç›®æ¨™èˆ‡é•·åº¦
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">ç›®æ¨™éšç´š</label>
                            <select id="targetRank" class="w-full border border-gray-300 rounded-md py-2 px-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="S2">å°‘å°‰ (S2)</option>
                                <option value="S3">ä¸­å°‰ (S3)</option>
                                <option value="S4">ä¸Šå°‰ (S4)</option>
                                <option value="M1">å°‘æ ¡ (M1)</option>
                                <option value="M2">ä¸­æ ¡ (M2)</option>
                                <option value="M3">ä¸Šæ ¡ (M3)</option>
                                <option value="G1" class="text-red-700 font-bold">å°‘å°‡ (G1)</option>
                                <option value="G2" class="text-red-700 font-bold">ä¸­å°‡ (G2)</option>
                                <option value="G3" class="text-red-700 font-bold">äºŒç´šä¸Šå°‡ (G3)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">é è¨ˆæœå½¹å¹´æ•¸</label>
                            <input type="number" id="serviceYears" value="25" min="10" max="40" class="w-full border border-gray-300 rounded-md py-2 px-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                    </div>
                    <p class="text-[10px] text-orange-500 mt-2">* è‹¥å¹´è³‡è¶…ééšç´šæœ€å¤§å¹´é™ï¼Œå°‡è§¸ç™¼å¼·åˆ¶é€€ä¼æ©Ÿåˆ¶ã€‚</p>
                </div>

                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-3 flex items-center">
                        <span class="bg-indigo-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">2</span> 
                        åŠ çµ¦èˆ‡çé‡‘
                    </h3>
                    
                    <div class="mb-4">
                        <label class="block text-xs font-medium text-gray-500 mb-1">å¹´çµ‚ + è€ƒç¸¾çé‡‘ (æœˆæ•¸)</label>
                        <div class="flex gap-2">
                            <div class="w-1/2">
                                <span class="text-[10px] text-gray-400 block">å¹´çµ‚ (é è¨­1.5)</span>
                                <input type="number" id="yearEndBonus" value="1.5" step="0.1" class="w-full border rounded-md py-1 px-2 text-sm">
                            </div>
                            <div class="w-1/2">
                                <span class="text-[10px] text-gray-400 block">è€ƒç¸¾ (é è¨­1.0)</span>
                                <input type="number" id="perfBonus" value="1.0" step="0.5" class="w-full border rounded-md py-1 px-2 text-sm">
                            </div>
                        </div>
                        <p class="text-[10px] text-green-600 mt-1">ç³»çµ±å°‡è‡ªå‹•è¨ˆç®—ï¼š(æœ¬ä¿¸+å°ˆæ¥­åŠ çµ¦) Ã— è¨­å®šå€ç‡</p>
                    </div>

                    <label class="block text-xs font-medium text-gray-500 mb-1">éšæ®µæ€§åŠ çµ¦ (æœˆé¡)</label>
                    <div id="custom-allowances-container" class="space-y-2"></div>
                    <button onclick="addCustomAllowance()" class="w-full mt-2 bg-white border border-indigo-300 text-indigo-600 text-xs font-bold py-2 rounded hover:bg-indigo-50 transition">
                        + æ–°å¢éšæ®µæ€§åŠ çµ¦ (å¦‚: ä¸»å®˜ã€å¤–å³¶)
                    </button>
                </div>

                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-3 flex items-center">
                        <span class="bg-indigo-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">3</span> 
                        äººç”Ÿå¤§äº‹ (å–®ç­†æ”¶æ”¯)
                    </h3>
                    <p class="text-[10px] text-gray-400 mb-2">è¼¸å…¥æ­£æ•¸ç‚ºæ”¶å…¥(è£œåŠ©)ï¼Œè² æ•¸ç‚ºæ”¯å‡º(è²·æˆ¿/è»Š)ã€‚</p>
                    <div id="life-events-container" class="space-y-2"></div>
                    <button onclick="addLifeEvent()" class="w-full mt-2 bg-white border border-pink-300 text-pink-600 text-xs font-bold py-2 rounded hover:bg-pink-50 transition">
                        + æ–°å¢äº‹ä»¶ (çµå©š/è²·æˆ¿/ç”Ÿå­)
                    </button>
                </div>

                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-3 flex items-center">
                        <span class="bg-indigo-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">4</span> 
                        ç†è²¡èˆ‡æ”¯å‡º
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-500">æ¯æœˆå›ºå®šå„²è“„ (å…ƒ)</label>
                            <input type="number" id="monthlySavings" value="20000" step="1000" class="w-full border border-indigo-200 bg-indigo-50 text-indigo-700 font-bold rounded-md py-2 px-3">
                        </div>
                        <div class="flex gap-4">
                            <div class="w-1/2">
                                <label class="block text-xs font-medium text-gray-500">å¹´å ±é…¬ç‡ (%)</label>
                                <input type="number" id="returnRate" value="5" step="0.5" class="w-full border rounded-md py-1 px-2">
                            </div>
                            <div class="w-1/2">
                                <label class="block text-xs font-medium text-gray-500">æœˆç”Ÿæ´»è²» (å…ƒ)</label>
                                <input type="number" id="livingCost" value="15000" step="1000" class="w-full border rounded-md py-1 px-2">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pt-4 pb-12">
                     <button onclick="runSimulation()" class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transform active:scale-95 transition">
                        ğŸš€ åŸ·è¡Œå…¨æ–¹ä½æ¨¡æ“¬
                    </button>
                </div>
            </div>
        </aside>

        <section class="w-full lg:w-2/3 bg-gray-50 p-6 scrollable-content">
            
            <div id="status-bar" class="hidden mb-4 p-3 rounded-md bg-yellow-100 border border-yellow-400 text-yellow-800 text-sm font-bold flex items-center">
                âš ï¸ <span id="status-text" class="ml-2"></span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-indigo-500">
                    <p class="text-xs text-gray-400 uppercase tracking-wider">é è¨ˆç´¯ç©ç¸½è³‡ç”¢</p>
                    <p id="total-asset" class="text-2xl font-black text-indigo-900 mt-1">--</p>
                    <p class="text-[10px] text-gray-400 mt-1">æœ¬é‡‘ + æŠ•è³‡è¤‡åˆ©</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
                    <p class="text-xs text-gray-400 uppercase tracking-wider">é ä¼°çµ‚èº«ä¿¸ (æœˆé€€)</p>
                    <p id="pension-monthly" class="text-2xl font-black text-green-700 mt-1">--</p>
                    <p id="pension-sub" class="text-[10px] text-gray-400 mt-1">éœ€æœå½¹æ»¿ 20 å¹´</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-500">
                    <p class="text-xs text-gray-400 uppercase tracking-wider">æœ€çµ‚éšç´šç‹€æ…‹</p>
                    <p id="final-status" class="text-xl font-bold text-gray-800 mt-1">--</p>
                    <p class="text-[10px] text-gray-400 mt-1">å¹´é™èˆ‡é€€ä¼åˆ¤æ–·</p>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-6 mb-8">
                <div class="bg-white p-5 rounded-xl shadow-sm">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        ğŸ“ˆ è³‡ç”¢ç´¯ç©èˆ‡è–ªè³‡èµ°å‹¢
                        <span class="ml-2 text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">å«çé‡‘èˆ‡äººç”Ÿå¤§äº‹</span>
                    </h2>
                    <div class="h-64">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>
                
                <div class="bg-white p-5 rounded-xl shadow-sm">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ’° ä¸åŒæŠ•è³‡æƒ…å¢ƒæ¯”è¼ƒ</h2>
                    <div class="h-64">
                        <canvas id="scenarioChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm mb-12">
                <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ“ å¹´åº¦é—œéµäº‹ä»¶ç´€éŒ„</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-4 py-2">å¹´åº¦</th>
                                <th class="px-4 py-2">éšç´š</th>
                                <th class="px-4 py-2">å¹´åº¦æ·¨æ”¶æ”¯</th>
                                <th class="px-4 py-2">ç‰¹æ®Šäº‹ä»¶</th>
                                <th class="px-4 py-2">ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="event-log-body">
                            </tbody>
                    </table>
                </div>
            </div>

        </section>
    </main>
    
    <script>
        // =========================================================
        // DATA SOURCE
        // =========================================================
        // æ–°å¢ max_years (æœ€å¤§æœå½¹å¹´é™) ä¾æ“šé™¸æµ·ç©ºè»è»å®˜å£«å®˜æœå½¹æ¢ä¾‹
        // å°‡å®˜å¹´é™æ”¹ç‚ºå¹´é½¡æ¨ç®— (å‡è¨­22æ­²ä»»å®˜)ï¼Œå°‘å°‡57æ­²(ç´„35å¹´)ï¼Œä¸­å°‡60æ­²(ç´„38å¹´)
        const REAL_SALARY_STRUCTURE = {
            'S2': { rank: 'å°‘å°‰', base: 22750, pro_add: 28000, food_add: 2840, promotion_years: 1, annual_growth: 0.015, max_years: 12 }, 
            'S3': { rank: 'ä¸­å°‰', base: 25050, pro_add: 30000, food_add: 2840, promotion_years: 3, annual_growth: 0.015, max_years: 12 },
            'S4': { rank: 'ä¸Šå°‰', base: 28880, pro_add: 35000, food_add: 2840, promotion_years: 4, annual_growth: 0.015, max_years: 17 }, 
            'M1': { rank: 'å°‘æ ¡', base: 32710, pro_add: 45000, food_add: 2840, promotion_years: 4, annual_growth: 0.015, max_years: 22 }, 
            'M2': { rank: 'ä¸­æ ¡', base: 37310, pro_add: 55000, food_add: 2840, promotion_years: 4, annual_growth: 0.015, max_years: 26 }, 
            'M3': { rank: 'ä¸Šæ ¡', base: 41900, pro_add: 65000, food_add: 2840, promotion_years: 6, annual_growth: 0.015, max_years: 30 }, 
            'G1': { rank: 'å°‘å°‡', base: 48030, pro_add: 70000, food_add: 2840, promotion_years: 4, annual_growth: 0.01, max_years: 35 }, 
            'G2': { rank: 'ä¸­å°‡', base: 53390, pro_add: 80000, food_add: 2840, promotion_years: 3, annual_growth: 0.01, max_years: 38 }, 
            'G3': { rank: 'äºŒç´šä¸Šå°‡', base: 109520, pro_add: 90000, food_add: 2840, promotion_years: Infinity, annual_growth: 0.01, max_years: 42 }
        };

        const RANK_ORDER = ['S2', 'S3', 'S4', 'M1', 'M2', 'M3', 'G1', 'G2', 'G3'];
        const VOLUNTEER_ADDITION_2026 = 15000;
        const PENSION_RATE = 0.14; 
        const INDIVIDUAL_PENSION_RATIO = 0.35; 

        let financialChartInstance;
        let scenarioChartInstance;
        let allowanceCounter = 0;
        let lifeEventCounter = 0;

        // --- è¼”åŠ©å‡½æ•¸ ---
        function formatCurrency(number) {
            if (isNaN(number)) return '--';
            const absNum = Math.abs(Math.round(number));
            const sign = number < 0 ? "-" : "";
            return `${sign}$${absNum.toLocaleString('zh-TW')}`;
        }

        // --- ä»‹é¢ç”Ÿæˆå‡½æ•¸ ---
        function addCustomAllowance() {
            allowanceCounter++;
            const container = document.getElementById('custom-allowances-container');
            const itemId = `custom-item-${allowanceCounter}`;
            
            let defaultName = "", defaultValue = 0, defaultStart = 1, defaultEnd = 5;
            if (allowanceCounter === 1 && container.children.length === 0) {
                defaultName = "ä¸»å®˜åŠ çµ¦(ç¯„ä¾‹)"; defaultValue = 6000; defaultStart = 5; defaultEnd = 8;
            }

            const html = `
                <div id="${itemId}" class="grid grid-cols-12 gap-1 items-center allowance-row mb-2 text-xs">
                    <div class="col-span-4"><input type="text" placeholder="é …ç›®" value="${defaultName}" class="w-full border rounded py-1 px-1 allow-name" oninput="runSimulation()"></div>
                    <div class="col-span-3"><input type="number" placeholder="$" value="${defaultValue}" class="w-full border rounded py-1 px-1 allow-value" oninput="runSimulation()"></div>
                    <div class="col-span-2"><input type="number" placeholder="å§‹" value="${defaultStart}" class="w-full border rounded py-1 px-1 text-center allow-start" oninput="runSimulation()"></div>
                    <div class="col-span-2"><input type="number" placeholder="æœ«" value="${defaultEnd}" class="w-full border rounded py-1 px-1 text-center allow-end" oninput="runSimulation()"></div>
                    <div class="col-span-1 text-center"><button onclick="document.getElementById('${itemId}').remove(); runSimulation()" class="text-red-500 font-bold">Ã—</button></div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

        function addLifeEvent() {
            lifeEventCounter++;
            const container = document.getElementById('life-events-container');
            const itemId = `life-event-${lifeEventCounter}`;
            
            let defaultName = "", defaultValue = 0, defaultYear = 5;
            if (lifeEventCounter === 1 && container.children.length === 0) {
                defaultName = "çµå©šè£œåŠ©"; defaultValue = 50000; defaultYear = 6;
            } else if (lifeEventCounter === 2) {
                defaultName = "è²·è»Šé ­æœŸ"; defaultValue = -200000; defaultYear = 8;
            }

            const html = `
                <div id="${itemId}" class="grid grid-cols-12 gap-1 items-center life-event-row mb-2 text-xs">
                    <div class="col-span-2 text-gray-500 pt-1 text-right pr-1">ç¬¬</div>
                    <div class="col-span-2"><input type="number" value="${defaultYear}" class="w-full border rounded py-1 px-1 text-center event-year" oninput="runSimulation()"></div>
                    <div class="col-span-1 text-gray-500 pt-1">å¹´</div>
                    <div class="col-span-4"><input type="text" placeholder="äº‹ä»¶" value="${defaultName}" class="w-full border rounded py-1 px-1 event-name" oninput="runSimulation()"></div>
                    <div class="col-span-2"><input type="number" placeholder="$" value="${defaultValue}" class="w-full border rounded py-1 px-1 event-amount" oninput="runSimulation()"></div>
                    <div class="col-span-1 text-center"><button onclick="document.getElementById('${itemId}').remove(); runSimulation()" class="text-red-500 font-bold">Ã—</button></div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

        // --- è³‡æ–™æ”¶é›†å‡½æ•¸ ---
        function getConfigs() {
            const allowances = [];
            document.querySelectorAll('.allowance-row').forEach(row => {
                const amount = parseInt(row.querySelector('.allow-value').value) || 0;
                const start = parseInt(row.querySelector('.allow-start').value) || 1;
                const end = parseInt(row.querySelector('.allow-end').value) || 99;
                if(amount !== 0) allowances.push({amount, start, end});
            });

            const events = [];
            document.querySelectorAll('.life-event-row').forEach(row => {
                const year = parseInt(row.querySelector('.event-year').value) || 0;
                const amount = parseInt(row.querySelector('.event-amount').value) || 0;
                const name = row.querySelector('.event-name').value || 'æœªå‘½å';
                if(amount !== 0 && year > 0) events.push({year, amount, name});
            });

            return { allowances, events };
        }

        // --- æ ¸å¿ƒé‚è¼¯ ---
        function runSimulation() {
            // è¼¸å…¥åƒæ•¸
            const targetRank = document.getElementById('targetRank').value;
            const serviceYearsInput = parseInt(document.getElementById('serviceYears').value) || 20;
            const monthlySavings = parseInt(document.getElementById('monthlySavings').value) || 0;
            const returnRate = parseFloat(document.getElementById('returnRate').value) / 100 || 0;
            const livingCost = parseInt(document.getElementById('livingCost').value) || 0;
            const bonusMonths = (parseFloat(document.getElementById('yearEndBonus').value) || 0) + (parseFloat(document.getElementById('perfBonus').value) || 0);

            const { allowances, events } = getConfigs();
            const targetRankIndex = RANK_ORDER.indexOf(targetRank);

            // è®Šæ•¸åˆå§‹åŒ–
            let currentAsset = 0;
            let currentRank = 'S2';
            let yearOfRank = 0;
            let forceRetired = false;
            let retiredYear = 0;
            
            // æ•¸æ“šé™£åˆ—
            const yearsLabel = [];
            const netIncomeData = [];
            const assetData = [];
            const eventLog = [];

            // 1. æ¨¡æ“¬è¿´åœˆ
            for (let year = 1; year <= serviceYearsInput; year++) {
                
                // A. å¼·åˆ¶é€€ä¼æª¢æŸ¥ (Check Force Retirement)
                const currentRankData = REAL_SALARY_STRUCTURE[currentRank];
                if (year > currentRankData.max_years) {
                    forceRetired = true;
                    retiredYear = year - 1;
                    // å¡«å…¥å¾ŒçºŒç©ºå€¼æˆ–ç¶­æŒæœ€å¾Œä¸€å¹´æ•¸æ“šä»¥åˆ©åœ–è¡¨é¡¯ç¤º (é€™è£¡é¸æ“‡ä¸­æ–·æ¨¡æ“¬)
                    break;
                }

                yearsLabel.push(`ç¬¬${year}å¹´`);

                // B. æ™‰å‡é‚è¼¯ (Promotion)
                const currentIndex = RANK_ORDER.indexOf(currentRank);
                if (yearOfRank >= currentRankData.promotion_years && currentIndex < targetRankIndex) {
                    // æª¢æŸ¥æ˜¯å¦é”åˆ°ç›®æ¨™
                    const nextRankIndex = currentIndex + 1;
                    if (nextRankIndex <= targetRankIndex) {
                        currentRank = RANK_ORDER[nextRankIndex];
                        yearOfRank = 0;
                    }
                }

                // C. è–ªè³‡è¨ˆç®— (Monthly Salary)
                // åŠ çµ¦ç¸½å’Œ
                let yearAllowance = 0;
                allowances.forEach(conf => { if(year >= conf.start && year <= conf.end) yearAllowance += conf.amount; });

                // ä¿¸ç´šæˆé•· (å¹´å¢ç‡)
                const growthFactor = (1 + currentRankData.annual_growth) ** (year - 1);
                
                const pensionBase = (currentRankData.base + currentRankData.pro_add) * growthFactor; // éš¨ä¿¸ç´šæˆé•·
                const grossMonthly = pensionBase + currentRankData.food_add + VOLUNTEER_ADDITION_2026 + yearAllowance;
                
                // æ‰£é™¤é€€æ’«
                const pensionDeduction = pensionBase * PENSION_RATE * INDIVIDUAL_PENSION_RATIO;
                const netMonthly = Math.round(grossMonthly - pensionDeduction);

                // D. å¹´åº¦ç¾é‡‘æµ (Annual Cashflow)
                // 1. æœˆè–ª x 12
                let annualIncome = netMonthly * 12;
                
                // 2. åŠ ä¸Šçé‡‘ (Base + Pro) * Multiplier (å‡è¨­çé‡‘ä¸æ‰£é€€æ’«ï¼Œä½†å¯¦å‹™å¯èƒ½é æ‰£ç¨…ï¼Œæ­¤è™•æ¡ç°¡åŒ–)
                const annualBonus = Math.round(pensionBase * bonusMonths);
                annualIncome += annualBonus;

                // 3. äººç”Ÿå¤§äº‹ (Life Events)
                let eventEffect = 0;
                let eventDesc = "";
                events.forEach(e => {
                    if (e.year === year) {
                        eventEffect += e.amount;
                        eventDesc += `${e.name}(${e.amount > 0 ? '+' : ''}${Math.round(e.amount/10000)}è¬) `;
                    }
                });
                annualIncome += eventEffect;

                // E. æ”¯å‡ºèˆ‡å„²è“„
                const annualExpense = livingCost * 12;
                const fixedSavings = monthlySavings * 12;
                
                // æ·¨ç¾é‡‘æµ (Net Cashflow) = ç¸½æ”¶ - ç¸½æ”¯ - å›ºå®šå„²è“„
                const netCashflow = annualIncome - annualExpense - fixedSavings;

                // F. è³‡ç”¢è¤‡åˆ©
                currentAsset = currentAsset * (1 + returnRate) + fixedSavings + (netCashflow > 0 ? netCashflow : 0); 
                // è¨»ï¼šè‹¥ç¾é‡‘æµç‚ºè² (é€æ”¯)ï¼Œå‡è¨­å¾è³‡ç”¢æ‰£é™¤? æˆ–æ˜¯å–®ç´”æ²’å­˜åˆ°éŒ¢?
                // é€™è£¡æ¡å–è¼ƒåš´æ ¼é‚è¼¯ï¼šå¦‚æœé€æ”¯ï¼Œè³‡ç”¢è¦æ‰£æ‰ (åƒè€æœ¬)
                if (netCashflow < 0) {
                    currentAsset += netCashflow;
                }

                // ç´€éŒ„æ•¸æ“š
                netIncomeData.push(netMonthly); // åœ–è¡¨é¡¯ç¤ºæœˆè–ªè¶¨å‹¢
                assetData.push(Math.round(currentAsset));
                
                // ç´€éŒ„äº‹ä»¶ç°¿
                eventLog.push({
                    year: year,
                    rank: REAL_SALARY_STRUCTURE[currentRank].rank,
                    net: netCashflow,
                    event: eventDesc,
                    status: netCashflow < 0 ? 'âš ï¸ é€æ”¯' : 'âœ… çµé¤˜'
                });

                yearOfRank++;
            }

            // 2. çµ‚èº«ä¿¸è©¦ç®— (Pension)
            let finalRankData = REAL_SALARY_STRUCTURE[currentRank];
            let actualServiceYears = forceRetired ? retiredYear : serviceYearsInput;
            let pensionMonthly = 0;
            let pensionEligible = actualServiceYears >= 20;

            if (pensionEligible) {
                // ç°¡æ˜“æ–°åˆ¶å…¬å¼ï¼šæœ¬ä¿¸x2 x (55% + 2% x (å¹´è³‡-20))
                const baseForPension = finalRankData.base * ((1 + finalRankData.annual_growth) ** (actualServiceYears - 1));
                const ratio = 0.55 + (actualServiceYears - 20) * 0.02;
                // ä¸Šé™æª¢æŸ¥ (æœ€é«˜ 95% æˆ–ä¾éšç´šä¸åŒï¼Œæ­¤è™•ç°¡åŒ–ä¸è¨­é ‚)
                pensionMonthly = Math.round(baseForPension * 2 * ratio);
            }

            // 3. æ›´æ–° UI
            document.getElementById('total-asset').innerText = formatCurrency(currentAsset);
            
            // çµ‚èº«ä¿¸é¡¯ç¤º
            const pensionEl = document.getElementById('pension-monthly');
            const pensionSubEl = document.getElementById('pension-sub');
            if (pensionEligible) {
                pensionEl.innerText = formatCurrency(pensionMonthly);
                pensionEl.className = "text-2xl font-black text-green-700 mt-1";
                pensionSubEl.innerText = `æœå½¹ ${actualServiceYears} å¹´ï¼Œç¬¦åˆè³‡æ ¼`;
            } else {
                pensionEl.innerText = "æœªé”é–€æª»";
                pensionEl.className = "text-xl font-bold text-gray-400 mt-1";
                pensionSubEl.innerText = `åƒ…æœå½¹ ${actualServiceYears} å¹´ (éœ€ 20 å¹´)`;
            }

            // ç‹€æ…‹é¡¯ç¤º
            const statusText = document.getElementById('status-text');
            const statusBar = document.getElementById('status-bar');
            const finalStatusEl = document.getElementById('final-status');
            
            if (forceRetired) {
                statusBar.classList.remove('hidden');
                statusText.innerText = `è­¦å‘Šï¼šæ‚¨åœ¨ç¬¬ ${retiredYear} å¹´å› é”åˆ°ã€${REAL_SALARY_STRUCTURE[currentRank].rank}ã€‘æœ€å¤§æœå½¹å¹´é™è€Œå¼·åˆ¶é€€ä¼ã€‚`;
                finalStatusEl.innerText = `å¼·åˆ¶é€€ä¼ (${REAL_SALARY_STRUCTURE[currentRank].rank})`;
                finalStatusEl.className = "text-xl font-bold text-red-600 mt-1";
            } else {
                statusBar.classList.add('hidden');
                finalStatusEl.innerText = `å…‰æ¦®é€€ä¼ (${REAL_SALARY_STRUCTURE[currentRank].rank})`;
                finalStatusEl.className = "text-xl font-bold text-indigo-600 mt-1";
            }

            // æ›´æ–°äº‹ä»¶è¡¨
            const tbody = document.getElementById('event-log-body');
            tbody.innerHTML = '';
            eventLog.forEach(log => {
                const row = `<tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-4 py-2">ç¬¬ ${log.year} å¹´</td>
                    <td class="px-4 py-2 font-medium text-gray-900">${log.rank}</td>
                    <td class="px-4 py-2 ${log.net < 0 ? 'text-red-600 font-bold' : 'text-green-600'}">${formatCurrency(log.net)}</td>
                    <td class="px-4 py-2 text-xs">${log.event || '-'}</td>
                    <td class="px-4 py-2 text-xs">${log.status}</td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });

            // 4. ç¹ªè£½åœ–è¡¨
            renderCharts(yearsLabel, netIncomeData, assetData, monthlySavings, actualServiceYears);
        }

        function renderCharts(labels, salaryData, assetData, monthlySavings, actualYears) {
            // Chart 1: è²¡å‹™ç¸½è¦½
            if (financialChartInstance) financialChartInstance.destroy();
            const ctx1 = document.getElementById('financialChart').getContext('2d');
            financialChartInstance = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'æœˆæ·¨è–ªè³‡ (å«å¹´å¢)', data: salaryData, borderColor: '#4F46E5', yAxisID: 'y1', tension: 0.1 },
                        { label: 'ç´¯ç©ç¸½è³‡ç”¢', data: assetData, borderColor: '#10B981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, yAxisID: 'y2', tension: 0.3 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y1: { position: 'left', title: {display: true, text: 'æœˆè–ª (å…ƒ)'} },
                        y2: { position: 'right', title: {display: true, text: 'ç¸½è³‡ç”¢ (å…ƒ)'}, grid: {drawOnChartArea: false} }
                    }
                }
            });

            // Chart 2: æŠ•è³‡æƒ…å¢ƒ
            if (scenarioChartInstance) scenarioChartInstance.destroy();
            
            // ç°¡å–®è¨ˆç®—ä¸‰ç¨®æƒ…å¢ƒ
            const calculateScenario = (rate) => {
                let val = 0;
                const data = [];
                for(let i=0; i<actualYears; i++) {
                    val = val * (1 + rate) + (monthlySavings * 12);
                    data.push(val);
                }
                return data;
            }
            
            const baseRate = parseFloat(document.getElementById('returnRate').value) / 100 || 0.05;
            const lowData = calculateScenario(0.02);
            const midData = calculateScenario(baseRate);
            const highData = calculateScenario(0.08);

            const ctx2 = document.getElementById('scenarioChart').getContext('2d');
            scenarioChartInstance = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ä¿å®ˆ (2%)', data: lowData, borderColor: '#F59E0B', tension: 0.2 },
                        { label: `è¨­å®š (${(baseRate*100).toFixed(1)}%)`, data: midData, borderColor: '#3B82F6', borderWidth: 3, tension: 0.2 },
                        { label: 'ç©æ¥µ (8%)', data: highData, borderColor: '#EC4899', tension: 0.2 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false
                }
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // é è¨­åŠ ä¸€ç­†ç”Ÿæ´»äº‹ä»¶
            addCustomAllowance();
            addLifeEvent();

            // ç¶å®šæ‰€æœ‰è¼¸å…¥æ¡†
            document.body.addEventListener('input', (e) => {
                if(e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                    runSimulation();
                }
            });

            runSimulation();
        });
    </script>
</body>
</html>
