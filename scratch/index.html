<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç©ºè»è²¡å‹™æ±ºç­–ç³»çµ± v14.0 | æ•¸æ“šç²¾ç®—ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #f8fafc; color: #0f172a; }
        .mono { font-family: 'Roboto Mono', monospace; }
        
        /* åš´è¬¹çš„è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #e2e8f0; padding: 8px; text-align: right; font-weight: 700; color: #475569; border: 1px solid #cbd5e1; white-space: nowrap; }
        td { padding: 6px 8px; text-align: right; border: 1px solid #e2e8f0; }
        th:first-child, td:first-child { text-align: center; }
        tr:nth-child(even) { background: #f8fafc; }
        tr:hover { background: #f1f5f9; }

        /* è¼¸å…¥æ¡† */
        input, select {
            width: 100%; padding: 6px; border: 1px solid #94a3b8; border-radius: 4px; font-size: 14px;
            background: #fff; transition: border 0.2s;
        }
        input:focus, select:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }
        
        /* å¼·åˆ¶åœ–è¡¨é«˜åº¦ */
        .chart-container { height: 320px; width: 100%; position: relative; }

        /* æŒ‰éˆ• */
        .btn { padding: 8px 16px; border-radius: 4px; font-weight: bold; cursor: pointer; text-align: center; font-size: 14px; }
        .btn-blue { background: #2563eb; color: white; border: 1px solid #1d4ed8; }
        .btn-blue:hover { background: #1d4ed8; }
        .btn-white { background: white; border: 1px solid #cbd5e1; color: #475569; }
        .btn-white:hover { background: #f1f5f9; border-color: #94a3b8; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-[320px] bg-white border-r border-slate-300 flex flex-col z-20 shadow-lg shrink-0">
        <div class="p-4 border-b border-slate-200 bg-slate-50">
            <h2 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                <span class="w-2 h-6 bg-blue-600"></span> åƒæ•¸è¨­å®š (Inputs)
            </h2>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 space-y-6">
            <div class="flex gap-2">
                <button onclick="app.switch('A')" id="btn-A" class="btn btn-blue flex-1">æ–¹æ¡ˆ A</button>
                <button onclick="app.switch('B')" id="btn-B" class="btn btn-white flex-1">æ–¹æ¡ˆ B</button>
            </div>

            <div class="space-y-2 border-b border-slate-200 pb-4">
                <h3 class="text-sm font-bold text-slate-500 uppercase">1. è·æ¶¯è¨­å®š</h3>
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-xs font-bold text-slate-600">ç›®æ¨™éšç´š</label><select id="targetRank"><option value="S2">å°‘å°‰</option><option value="S3">ä¸­å°‰</option><option value="S4">ä¸Šå°‰</option><option value="M1">å°‘æ ¡</option><option value="M2">ä¸­æ ¡</option><option value="M3">ä¸Šæ ¡</option><option value="G1">å°‘å°‡</option></select></div>
                    <div><label class="text-xs font-bold text-slate-600">æœå½¹å¹´æ•¸</label><input type="number" id="serviceYears" value="20"></div>
                </div>
                <button onclick="app.loadAFData()" class="w-full py-1 text-xs text-blue-600 border border-blue-200 rounded hover:bg-blue-50 font-bold">â¬‡ è¼‰å…¥ç©ºè»åŠ çµ¦é è¨­å€¼</button>
                <div id="allowance-list" class="space-y-1 mt-1"></div>
            </div>

            <div class="space-y-2 border-b border-slate-200 pb-4">
                <h3 class="text-sm font-bold text-slate-500 uppercase">2. æŠ•è³‡åƒæ•¸</h3>
                <div class="bg-blue-50 p-3 rounded border border-blue-100">
                    <div class="flex justify-between mb-1">
                        <label class="text-xs font-bold text-blue-800">æœˆè–ªææ’¥ç‡</label>
                        <span id="slider-val" class="text-sm font-bold text-blue-600">30%</span>
                    </div>
                    <input type="range" id="investSlider" min="0" max="90" value="30" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer" oninput="document.getElementById('slider-val').innerText=this.value+'%'; app.calc()">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-xs font-bold text-slate-600">å¹´åŒ–å ±é…¬(%)</label><input type="number" id="returnRate" value="6.0" class="font-bold text-green-600"></div>
                    <div><label class="text-xs font-bold text-slate-600">é€šè†¨ç‡(%)</label><input type="number" id="inflationRate" value="2.0"></div>
                </div>
                <div id="invest-list" class="space-y-1"></div>
                <button onclick="app.addInvestItem()" class="text-xs text-slate-400 hover:text-blue-600 block w-full text-center">+ å¢åŠ å›ºå®šæŠ•è³‡é …ç›®</button>
            </div>

            <div class="space-y-2 pb-10">
                <h3 class="text-sm font-bold text-slate-500 uppercase">3. æ”¯å‡ºèˆ‡æˆ¿ç”¢</h3>
                <div id="expense-list" class="space-y-1"></div>
                <button onclick="app.addExpenseItem()" class="text-xs text-slate-400 hover:text-blue-600 block w-full text-center mb-2">+ å¢åŠ æ”¯å‡ºé …ç›®</button>
                
                <div class="border border-slate-300 rounded p-2 bg-slate-50">
                    <label class="flex items-center gap-2 mb-2 cursor-pointer">
                        <input type="checkbox" id="buyHouseToggle" class="w-4 h-4" onchange="app.calc()">
                        <span class="text-sm font-bold text-slate-700">å•Ÿç”¨æˆ¿ç”¢è©¦ç®—</span>
                    </label>
                    <div id="housing-inputs" class="grid grid-cols-2 gap-2 hidden">
                        <div><label class="text-[10px]">ç¬¬Nå¹´è²·</label><input type="number" id="buyYear" value="10"></div>
                        <div><label class="text-[10px]">ç¸½åƒ¹(è¬)</label><input type="number" id="housePriceWan" value="1500"></div>
                        <div><label class="text-[10px]">é ­æœŸ(%)</label><input type="number" id="downPaymentPct" value="20"></div>
                        <div><label class="text-[10px]">åˆ©ç‡(%)</label><input type="number" id="mortgageRate" value="2.2"></div>
                        <div><label class="text-[10px]">å¹´é™</label><input type="number" id="loanTerm" value="30"></div>
                        <div><label class="text-[10px]">å¹´å¢å€¼(%)</label><input type="number" id="houseAppreciation" value="1.5"></div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full bg-slate-50 overflow-hidden">
        
        <div class="h-24 bg-white border-b border-slate-300 flex items-center px-6 gap-8 shrink-0 shadow-sm">
            <div>
                <p class="text-xs text-slate-500 font-bold uppercase">é ä¼°æœŸæ»¿æ·¨è³‡ç”¢ (åç›®)</p>
                <p id="kpi-asset" class="text-3xl font-black text-slate-800 mono">--</p>
            </div>
            <div class="h-10 w-px bg-slate-200"></div>
            <div>
                <p class="text-xs text-slate-500 font-bold uppercase">æŠ•è³‡ç²åˆ©è²¢ç»</p>
                <p id="kpi-invest-gain" class="text-2xl font-bold text-green-600 mono">--</p>
            </div>
            <div class="h-10 w-px bg-slate-200"></div>
            <div>
                <p class="text-xs text-slate-500 font-bold uppercase">çµ‚èº«ä¿¸ (æœˆé€€)</p>
                <p id="kpi-pension" class="text-2xl font-bold text-blue-600 mono">--</p>
            </div>
            <div class="ml-auto">
                <button onclick="exportCSV()" class="btn btn-white text-xs">ğŸ“¥ åŒ¯å‡º Excel (CSV)</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-6">
            
            <div id="alert-box" class="hidden bg-red-50 border-l-4 border-red-500 p-4 text-red-700">
                <p class="font-bold">âš ï¸ è²¡å‹™è­¦ç¤ºï¼šåµæ¸¬åˆ°ç¾é‡‘æµèµ¤å­— (é€æ”¯)</p>
                <p class="text-sm">åœ¨éƒ¨åˆ†å¹´åº¦æ‚¨çš„æ”¯å‡ºå¤§æ–¼æ”¶å…¥ï¼Œç³»çµ±å·²å¾ç¾é‡‘æ± æ‰£æ¬¾ (é¡¯ç¤ºç‚ºè² å€¼)ï¼Œè«‹æª¢æŸ¥ã€Œç¾é‡‘çµé¤˜ã€æ¬„ä½ã€‚</p>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <div class="bg-white p-4 rounded shadow border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-2 border-b pb-2">è³‡ç”¢ç´¯ç©è¶¨å‹¢ (Asset Growth)</h3>
                    <div class="chart-container"><canvas id="chart-asset"></canvas></div>
                </div>
                <div class="bg-white p-4 rounded shadow border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-2 border-b pb-2">è³‡ç”¢çµæ§‹ (Composition)</h3>
                    <div class="chart-container"><canvas id="chart-wealth"></canvas></div>
                </div>
            </div>

            <div class="bg-white rounded shadow border border-slate-200 overflow-hidden">
                <div class="p-3 bg-slate-100 border-b border-slate-200 font-bold text-slate-700 flex justify-between">
                    <span>è©³ç´°è²¡å‹™æ˜ç´° (Financial Statement)</span>
                    <span class="text-xs text-slate-500 font-normal self-center">* å–®ä½ï¼šæ–°å°å¹£å…ƒ</span>
                </div>
                <div class="overflow-x-auto">
                    <table id="data-table">
                        <thead>
                            <tr>
                                <th>å¹´åº¦</th>
                                <th>éšç´š</th>
                                <th>ç¸½æ”¶å…¥ (å¹´)</th>
                                <th class="text-red-600">ç¸½æ”¯å‡º</th>
                                <th class="text-green-600">æŠ•å…¥æŠ•è³‡</th>
                                <th>æˆ¿è²¸æ”¯å‡º</th>
                                <th class="bg-blue-50 text-blue-700 border-x-2 border-blue-200">ç¾é‡‘çµé¤˜</th>
                                <th>æŠ•è³‡ç¸½å€¼</th>
                                <th>ç¾é‡‘ç¸½å€¼</th>
                                <th>æˆ¿ç”¢æ·¨å€¼</th>
                                <th class="bg-slate-800 text-white">æ·¨è³‡ç”¢ç¸½é¡</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="mono text-slate-600"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="h-10"></div>
        </div>
    </main>

<script>
/**
 * V14.0 Data Precision Core
 * Logic: Strict separation of pools. 
 * Validation: Force numeric parsing.
 */
const APP = {
    data: { A: {}, B: {} },
    curr: 'A',
    charts: {},
    ranks: ['S2','S3','S4','M1','M2','M3','G1'],
    // è–ªè³‡è¡¨: base(æœ¬ä¿¸), add(å°ˆæ¥­åŠ çµ¦), max(æœ€å¤§å¹´è³‡)
    salary: {
        'S2':{b:22750,a:28000,m:10}, 'S3':{b:25050,a:30000,m:10},
        'S4':{b:28880,a:35000,m:15}, 'M1':{b:32710,a:45000,m:20},
        'M2':{b:37310,a:55000,m:24}, 'M3':{b:41900,a:65000,m:28},
        'G1':{b:48030,a:70000,m:30}
    },

    // --- Utils ---
    N: v => { const n = parseFloat(String(v).replace(/,/g,'')); return isNaN(n) ? 0 : n; },
    F: n => Math.round(n).toLocaleString('en-US'),

    // --- Init ---
    init: () => {
        // è¨­å®š Chart.js é è¨­å­—é«”
        Chart.defaults.font.family = "'Roboto Mono', 'Noto Sans TC', sans-serif";
        Chart.defaults.color = '#64748b';

        const def = {
            targetRank:'M2', serviceYears:20, inflationRate:2, salaryRaiseRate:1, returnRate:6,
            buyHouseToggle:false, buyYear:10, housePriceWan:1500, downPaymentPct:20, mortgageRate:2.2, loanTerm:30, houseAppreciation:1.5,
            investSliderPct:30,
            allowances:[], expenses:[{name:'ç”Ÿæ´»è²»',val:12000}], investments:[{name:'å„²è“„éšª',val:3000}]
        };
        
        APP.data.A = JSON.parse(JSON.stringify(def));
        APP.data.B = JSON.parse(JSON.stringify(def));
        APP.data.B.returnRate = 4;
        
        document.body.addEventListener('input', e => {
            if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT') APP.calc();
        });
        
        APP.renderInputs('A');
        setTimeout(APP.calc, 200);
    },

    switch: s => {
        APP.save(); APP.curr = s;
        document.getElementById('btn-A').className = s==='A' ? 'btn btn-blue flex-1' : 'btn btn-white flex-1';
        document.getElementById('btn-B').className = s==='B' ? 'btn btn-blue flex-1' : 'btn btn-white flex-1';
        APP.renderInputs(s); APP.calc();
    },

    // --- Data Handling ---
    save: () => {
        const d = APP.data[APP.curr];
        ['targetRank','serviceYears','inflationRate','salaryRaiseRate','returnRate','buyYear','housePriceWan','downPaymentPct','mortgageRate','loanTerm','houseAppreciation','investSlider'].forEach(k => {
            const el = document.getElementById(k); if(el) d[k==='investSlider'?'investSliderPct':k] = k==='targetRank'?el.value:APP.N(el.value);
        });
        d.buyHouseToggle = document.getElementById('buyHouseToggle').checked;
        d.allowances = APP.readList('allowance-list');
        d.expenses = APP.readList('expense-list');
        d.investments = APP.readList('invest-list');
    },

    renderInputs: s => {
        const d = APP.data[s];
        ['targetRank','serviceYears','inflationRate','salaryRaiseRate','returnRate','buyYear','housePriceWan','downPaymentPct','mortgageRate','loanTerm','houseAppreciation'].forEach(k => document.getElementById(k).value = d[k]);
        document.getElementById('investSlider').value = d.investSliderPct;
        document.getElementById('slider-val').innerText = d.investSliderPct + '%';
        document.getElementById('buyHouseToggle').checked = d.buyHouseToggle;
        
        APP.renderList('allowance-list', d.allowances);
        APP.renderList('expense-list', d.expenses);
        APP.renderList('invest-list', d.investments);
        
        const h = document.getElementById('housing-inputs');
        if(d.buyHouseToggle) { h.classList.remove('hidden'); h.classList.add('grid'); } else { h.classList.add('hidden'); h.classList.remove('grid'); }
    },

    // --- List Helpers ---
    renderList: (id, list) => {
        const c = document.getElementById(id); c.innerHTML = '';
        list.forEach(i => {
            let ex = id==='allowance-list' ? `<input type="number" class="w-14 text-center" value="${i.start||1}">-<input type="number" class="w-14 text-center" value="${i.end||20}">` : '';
            c.innerHTML += `<div class="flex gap-1 mb-1 list-item"><input type="text" value="${i.name}" class="flex-1"><input type="number" value="${i.val}" class="w-20 text-right text-blue-600 font-bold">${ex}<button onclick="this.parentElement.remove();app.calc()" class="text-red-500 font-bold px-2">x</button></div>`;
        });
    },
    readList: id => {
        const arr = [];
        document.getElementById(id).querySelectorAll('.list-item').forEach(r => {
            const inputs = r.querySelectorAll('input');
            if(id==='allowance-list') arr.push({name:inputs[0].value, val:APP.N(inputs[1].value), start:APP.N(inputs[2].value), end:APP.N(inputs[3].value)});
            else arr.push({name:inputs[0].value, val:APP.N(inputs[1].value)});
        });
        return arr;
    },
    addItem: id => {
        const l = id==='allowance-list'?APP.data[APP.curr].allowances:(id==='expense-list'?APP.data[APP.curr].expenses:APP.data[APP.curr].investments);
        l.push({name:'æ–°é …ç›®', val:0, start:1, end:20}); APP.renderList(id, l); APP.calc();
    },
    loadAFData: () => {
        const d = APP.data[APP.curr];
        d.allowances = [{name:'ç©ºå‹¤(åˆ)',val:22000,start:1,end:5},{name:'ç©ºå‹¤(ä¸­)',val:45000,start:6,end:15},{name:'ç©ºå‹¤(é«˜)',val:68000,start:16,end:25}];
        APP.renderList('allowance-list', d.allowances); APP.calc();
    },
    addExpenseItem: () => APP.addItem('expense-list'),
    addInvestItem: () => APP.addItem('invest-list'),

    // --- ç²¾ç®—é‚è¼¯ (Calculation Engine) ---
    run: d => {
        const N = APP.N;
        const years = N(d.serviceYears)||20, inf = N(d.inflationRate)/100, raise = N(d.salaryRaiseRate)/100, roi = N(d.returnRate)/100, pct = N(d.investSliderPct)/100;
        
        let rank = 'S2', rankY = 0;
        let invPool = 0;  // æŠ•è³‡æ±  (æœ‰è¤‡åˆ©)
        let cashPool = 0; // ç¾é‡‘æ±  (ç„¡è¤‡åˆ©)
        let houseVal = 0, loanBal = 0, mPay = 0, hasHouse = false;
        
        const targetIdx = APP.ranks.indexOf(d.targetRank);
        const res = { years:[], net:[], invP:[], cashP:[], houseNet:[], log:[] };
        
        const baseExp = d.expenses.reduce((s,x)=>s+N(x.val),0);
        const baseInv = d.investments.reduce((s,x)=>s+N(x.val),0);

        for(let y=1; y<=years; y++) {
            // A. æ™‰å‡é‚è¼¯
            const rInfo = APP.salary[rank], rIdx = APP.ranks.indexOf(rank);
            if(y>1 && y%4===0 && rIdx<targetIdx && rankY<rInfo.m) { rank = APP.ranks[rIdx+1]; rankY=0; } else rankY++;

            // B. è–ªè³‡è¨ˆç®— (å¹´è³‡è¤‡åˆ© + æ”¿ç­–èª¿è–ª)
            const payBase = (APP.salary[rank].b + APP.salary[rank].a) * Math.pow(1.015, rankY) * Math.pow(1+raise, y-1);
            let allow = 0; d.allowances.forEach(a => { if(y>=N(a.start) && y<=N(a.end)) allow+=N(a.val); });
            const gross = payBase + 15000 + allow; // 15000ç‚ºå¿—é¡˜å½¹
            const netM = Math.round(gross * 0.95); // æ‰£é™¤é€€æ’«å¥ä¿

            // C. æˆ¿ç”¢è¨ˆç®—
            let yMort = 0;
            if(d.buyHouseToggle && y===N(d.buyYear) && !hasHouse) {
                hasHouse = true; houseVal = N(d.housePriceWan)*10000;
                const down = houseVal*(N(d.downPaymentPct)/100); 
                loanBal = houseVal - down;
                
                // é ­æœŸæ¬¾æ”¯ä»˜é †åº: ç¾é‡‘ -> æŠ•è³‡
                if(cashPool >= down) { cashPool -= down; }
                else { const rem = down - cashPool; cashPool = 0; invPool -= rem; }
                
                const r=N(d.mortgageRate)/100/12, n=N(d.loanTerm)*12;
                mPay = loanBal*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1);
            }
            if(hasHouse) {
                houseVal *= (1+N(d.houseAppreciation)/100);
                if(loanBal > 0) {
                    yMort = mPay * 12;
                    loanBal -= (yMort - loanBal*(N(d.mortgageRate)/100)); // ç°¡æ˜“æœ¬é‡‘æ‰£é™¤
                    if(loanBal < 0) loanBal = 0;
                }
            }

            // D. é‡‘æµçµç®—
            const yInc = netM * 13.5;
            const yEx = baseExp * Math.pow(1+inf, y-1) * 12;
            const yInvIn = (netM * pct + baseInv) * 12; // æŠ•å…¥æŠ•è³‡æ± çš„æœ¬é‡‘
            
            // ç¾é‡‘çµé¤˜ = æ”¶å…¥ - æ”¯å‡º - æŠ•å…¥æŠ•è³‡ - æˆ¿è²¸
            const ySurplus = yInc - yEx - yInvIn - yMort;

            // E. è³‡ç”¢è®Šå‹•
            invPool = invPool * (1+roi) + yInvIn;
            cashPool = cashPool + ySurplus; // çµé¤˜è¨ˆå…¥ç¾é‡‘æ±  (è‹¥è² å€¼å‰‡æ‰£æ¸›)

            const houseNet = Math.max(0, houseVal - loanBal);
            const totalNet = invPool + cashPool + houseNet;

            // F. ç´€éŒ„
            res.years.push(y);
            res.net.push(totalNet);
            res.invP.push(invPool);
            res.cashP.push(cashPool);
            res.houseNet.push(houseNet);
            
            res.log.push({
                y, rank, 
                inc: yInc, ex: yEx, invIn: yInvIn, mort: yMort, surplus: ySurplus,
                invVal: invPool, cashVal: cashPool, houseVal: houseVal, loan: loanBal, net: totalNet
            });
        }
        
        // çµ‚èº«ä¿¸ (ç°¡å–®æ¨¡å‹ï¼šæœ¬ä¿¸*2*æ›¿ä»£ç‡)
        res.pension = Math.round(APP.salary[rank].b * 2 * (0.55 + Math.max(0, years-20)*0.02));
        return res;
    },

    // --- UI Update ---
    calc: () => {
        APP.save();
        const rA = APP.run(APP.data.A), rB = APP.run(APP.data.B);
        APP.ui(APP.curr==='A'?rA:rB, APP.curr==='A'?rB:rA);
    },

    ui: (r, c) => {
        const l = r.net.length-1;
        document.getElementById('kpi-asset').innerText = APP.F(r.net[l]);
        document.getElementById('kpi-invest-gain').innerText = APP.F(r.invP[l]); // é¡¯ç¤ºæŠ•è³‡ç¸½å€¼
        document.getElementById('kpi-pension').innerText = APP.F(r.pension);
        
        // Alert Logic
        const alertBox = document.getElementById('alert-box');
        const hasDeficit = r.log.some(x => x.surplus < 0);
        if(hasDeficit) alertBox.classList.remove('hidden'); else alertBox.classList.add('hidden');

        // Table Render
        const tb = document.getElementById('table-body');
        tb.innerHTML = '';
        r.log.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.y}</td>
                <td class="font-bold text-slate-700">${row.rank}</td>
                <td>${APP.F(row.inc)}</td>
                <td class="text-red-600">${APP.F(row.ex)}</td>
                <td class="text-green-600 font-bold">${APP.F(row.invIn)}</td>
                <td class="text-slate-500">${APP.F(row.mort)}</td>
                <td class="bg-blue-50 font-bold ${row.surplus<0?'text-red-600':'text-blue-700'}">${APP.F(row.surplus)}</td>
                <td>${APP.F(row.invVal)}</td>
                <td class="${row.cashVal<0?'text-red-600 font-bold':''}">${APP.F(row.cashVal)}</td>
                <td>${APP.F(Math.max(0, row.houseVal - row.loan))}</td>
                <td class="bg-slate-800 text-white font-bold">${APP.F(row.net)}</td>
            `;
            tb.appendChild(tr);
        });

        APP.draw(r, c);
    },

    draw: (r, c) => {
        const labels = r.years.map(y => 'ç¬¬'+y+'å¹´');
        
        // 1. Asset Line Chart
        if(APP.charts.asset) APP.charts.asset.destroy();
        APP.charts.asset = new Chart(document.getElementById('chart-asset'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'æœ¬æ–¹æ¡ˆæ·¨è³‡ç”¢', data: r.net, borderColor: '#2563eb', borderWidth: 3, tension: 0.3 },
                    { label: 'å°ç…§çµ„', data: c.net, borderColor: '#94a3b8', borderWidth: 2, borderDash: [5,5] }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // 2. Composition Bar Chart (Stacked) -> Changed to Line for clarity per request? No, Composition is better as stacked bar or area.
        // User asked for "charts showing data". Let's stick to simple lines for components to see them grow.
        if(APP.charts.wealth) APP.charts.wealth.destroy();
        APP.charts.wealth = new Chart(document.getElementById('chart-wealth'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'æŠ•è³‡ç¸½å€¼', data: r.invP, borderColor: '#16a34a', backgroundColor: 'rgba(22, 163, 74, 0.1)', fill: true },
                    { label: 'ç¾é‡‘ç¸½å€¼', data: r.cashP, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true },
                    { label: 'æˆ¿ç”¢æ·¨å€¼', data: r.houseNet, borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.1)', fill: true }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { stacked: false } } }
        });
    }
};

window.onload = APP.init;
window.app = APP;
</script>
</body>
</html>
