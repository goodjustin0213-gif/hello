<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è»å®˜è·æ¶¯è²¡å‹™æˆ°æƒ…å®¤ | æ±ºç­–æ”¯æ´ç³»çµ±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        military: {
                            900: '#1a2e45', // æ·±æµ·è»è—
                            800: '#2c435f',
                            700: '#3e5879',
                            gold: '#c5a065', // æ¦®è­½é‡‘
                            red: '#be123c',  // è­¦ç¤ºç´…
                        }
                    },
                    fontFamily: {
                        serif: ['"Noto Serif TC"', 'serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f3f4f6; font-family: 'Noto Sans TC', sans-serif; color: #334155; }
        h1, h2, h3, h4 { font-family: 'Noto Serif TC', serif; }
        .scrollable-content { height: calc(100vh - 4rem); overflow-y: auto; scrollbar-width: thin; }
        .scrollable-content::-webkit-scrollbar { width: 6px; }
        .scrollable-content::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* è¼¸å…¥æ¡†é¢¨æ ¼ */
        .input-field {
            transition: all 0.2s;
            border: 1px solid #cbd5e1;
        }
        .input-field:focus {
            border-color: #1a2e45;
            box-shadow: 0 0 0 2px rgba(26, 46, 69, 0.1);
            outline: none;
        }
        .section-label {
            border-left: 4px solid #c5a065;
            padding-left: 0.75rem;
            color: #1a2e45;
            font-weight: 700;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }
    </style>
</head>
<body class="overflow-hidden bg-gray-100">

    <header class="bg-military-900 text-white h-16 px-6 shadow-md flex justify-between items-center z-20 relative border-b-4 border-military-gold">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-military-gold rounded text-military-900 flex items-center justify-center font-black font-serif">æ±º</div>
            <div>
                <h1 class="text-xl font-bold tracking-wider leading-tight">è»å®˜è·æ¶¯è²¡å‹™æˆ°æƒ…å®¤</h1>
                <p class="text-gray-400 text-[10px] tracking-widest uppercase">Decision Support System</p>
            </div>
        </div>
        <div class="text-xs text-military-gold font-bold border border-military-gold px-2 py-1 rounded">
            ROCM Version 2026
        </div>
    </header>

    <main class="flex flex-col lg:flex-row h-[calc(100vh-4rem)]">
        
        <aside class="w-full lg:w-96 bg-white border-r border-gray-300 shadow-xl z-10 overflow-y-auto scrollable-content pb-20">
            <div class="p-5 space-y-8">
                
                <div>
                    <h3 class="section-label">01. éšç´šèˆ‡æœå½¹è¦åŠƒ</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-bold text-gray-500">ç›®æ¨™éšç´š</label>
                            <select id="targetRank" class="input-field w-full rounded p-2 text-sm bg-gray-50 font-bold text-military-900">
                                <option value="S2">å°‘å°‰ (S2)</option>
                                <option value="S3">ä¸­å°‰ (S3)</option>
                                <option value="S4">ä¸Šå°‰ (S4)</option>
                                <option value="M1">å°‘æ ¡ (M1)</option>
                                <option value="M2">ä¸­æ ¡ (M2)</option>
                                <option value="M3">ä¸Šæ ¡ (M3)</option>
                                <option value="G1" class="text-military-gold bg-military-900">å°‘å°‡ (G1)</option>
                                <option value="G2" class="text-military-gold bg-military-900">ä¸­å°‡ (G2)</option>
                                <option value="G3" class="text-military-gold bg-military-900">äºŒç´šä¸Šå°‡ (G3)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">é è¨ˆæœå½¹å¹´æ•¸</label>
                            <input type="number" id="serviceYears" value="20" class="input-field w-full rounded p-2 text-sm bg-gray-50">
                        </div>
                    </div>
                    
                    <div class="mt-3 bg-gray-50 p-3 rounded border border-gray-200">
                        <label class="text-xs font-bold text-gray-500 mb-2 block">ç‰¹æ®ŠåŠ çµ¦ (æœˆé¡)</label>
                        <div id="custom-allowances-container" class="space-y-2"></div>
                        <button onclick="addCustomAllowance()" class="w-full mt-2 text-xs text-military-700 border border-dashed border-military-700 rounded py-1 hover:bg-military-100 transition">
                            + æ–°å¢è·å‹™/åœ°åŸŸåŠ çµ¦
                        </button>
                    </div>
                </div>

                <div>
                    <h3 class="section-label">02. è–ªè³‡èˆ‡æŠ•è³‡åƒæ•¸</h3>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="text-xs font-bold text-gray-500">æœˆç”Ÿæ´»æ”¯å‡º</label>
                            <input type="number" id="livingCost" value="15000" class="input-field w-full rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">æœˆæŠ•è³‡å„²è“„</label>
                            <input type="number" id="monthlySavings" value="20000" class="input-field w-full rounded p-2 text-sm font-bold text-green-700 bg-green-50">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <div>
                            <label class="text-[10px] font-bold text-gray-400">å¹´çµ‚(æœˆ)</label>
                            <input type="number" id="yearEndBonus" value="1.5" step="0.5" class="input-field w-full rounded p-1.5 text-sm text-center">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-400">è€ƒç¸¾(æœˆ)</label>
                            <input type="number" id="perfBonus" value="1.0" step="0.5" class="input-field w-full rounded p-1.5 text-sm text-center">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-400">å¹´åŒ–å ±é…¬%</label>
                            <input type="number" id="returnRate" value="6" step="0.5" class="input-field w-full rounded p-1.5 text-sm text-center font-bold text-blue-700">
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="section-label border-l-military-red">03. äººç”Ÿå¤§äº‹ (Life Events)</h3>
                    <p class="text-[10px] text-gray-400 mb-2">è¼¸å…¥æ­£æ•¸ç‚ºè£œåŠ©/æ”¶å…¥ï¼Œè² æ•¸ç‚ºå¤§é¡æ”¯å‡º(è³¼å±‹/è²·è»Š)</p>
                    <div id="life-events-container" class="space-y-2"></div>
                    <button onclick="addLifeEvent()" class="w-full mt-2 text-xs text-military-red border border-dashed border-military-red rounded py-1 hover:bg-red-50 transition">
                        + æ–°å¢é‡å¤§è²¡å‹™äº‹ä»¶
                    </button>
                </div>
                
                <div class="pt-4">
                    <button onclick="runSimulation()" class="w-full bg-military-900 hover:bg-military-800 text-white font-serif font-bold py-3 rounded shadow-lg transition tracking-widest border-b-4 border-military-gold active:translate-y-1 active:border-b-0">
                        åŸ·è¡Œæˆ°ç•¥æ¨¡æ“¬
                    </button>
                </div>
            </div>
        </aside>

        <section class="w-full lg:flex-1 bg-gray-100 p-6 scrollable-content">
            
            <div id="status-bar" class="hidden bg-red-100 border-l-4 border-red-600 text-red-700 p-3 mb-6 rounded-r shadow-sm flex items-center">
                <span class="text-xl mr-2">âš ï¸</span>
                <p id="status-text" class="text-sm font-bold">è­¦å‘Šè¨Šæ¯</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
                <div class="bg-white p-5 rounded border-t-4 border-military-gold shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">é ä¼°ç´¯ç©è³‡ç”¢</p>
                            <p id="total-asset" class="text-3xl font-serif font-black text-military-900 mt-1">--</p>
                        </div>
                        <div class="bg-military-100 text-military-900 p-2 rounded-full">ğŸ’°</div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded border-t-4 border-green-600 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">çµ‚èº«ä¿¸ (æœˆé€€)</p>
                            <p id="pension-monthly" class="text-3xl font-serif font-black text-green-700 mt-1">--</p>
                            <p id="pension-sub" class="text-[10px] text-gray-400 mt-1">--</p>
                        </div>
                        <div class="bg-green-100 text-green-700 p-2 rounded-full">ğŸŒ²</div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded border-t-4 border-military-700 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">æœ€çµ‚ç‹€æ…‹</p>
                            <p id="final-status" class="text-2xl font-bold text-gray-800 mt-1">--</p>
                        </div>
                        <div class="bg-gray-100 text-gray-600 p-2 rounded-full">ğŸ</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-4 rounded shadow-sm border border-gray-200">
                    <h4 class="font-bold text-military-900 mb-4 border-b pb-2">è–ªè³‡æˆé•·èˆ‡è³‡ç”¢ç´¯ç©</h4>
                    <div class="h-64">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 rounded shadow-sm border border-gray-200">
                    <h4 class="font-bold text-military-900 mb-4 border-b pb-2">æŠ•è³‡æƒ…å¢ƒåˆ†æ (è¤‡åˆ©æ•ˆæ‡‰)</h4>
                    <div class="h-64">
                        <canvas id="scenarioChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded shadow-sm border border-gray-200 overflow-hidden">
                <h4 class="font-serif font-bold text-white bg-military-800 p-3">
                    ğŸ“‘ å¹´åº¦è²¡å‹™ç´€éŒ„ (Event Log)
                </h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500 font-bold border-b">
                            <tr>
                                <th class="px-4 py-3">å¹´åº¦</th>
                                <th class="px-4 py-3">éšç´š</th>
                                <th class="px-4 py-3">å¹´åº¦æ·¨ç¾é‡‘æµ</th>
                                <th class="px-4 py-3">é‡å¤§äº‹ä»¶</th>
                                <th class="px-4 py-3">ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="event-log-body" class="divide-y divide-gray-100">
                            </tbody>
                    </table>
                </div>
            </div>

        </section>
    </main>

    <script>
        // =========================================================
        // 1. è³‡æ–™ä¾†æºèˆ‡åƒæ•¸è¨­å®š
        // =========================================================

        const REAL_SALARY_STRUCTURE = {
            // ã€å°‰å®˜ã€‘
            'S2': { rank: 'å°‘å°‰', base: 22750, pro_add: 28000, food_add: 2840, promotion_years: 1, annual_growth: 0.015, max_years: 12 }, 
            'S3': { rank: 'ä¸­å°‰', base: 25050, pro_add: 30000, food_add: 2840, promotion_years: 3, annual_growth: 0.015, max_years: 12 },
            'S4': { rank: 'ä¸Šå°‰', base: 28880, pro_add: 35000, food_add: 2840, promotion_years: 4, annual_growth: 0.015, max_years: 17 }, 
            
            // ã€æ ¡å®˜ã€‘
            'M1': { rank: 'å°‘æ ¡', base: 32710, pro_add: 45000, food_add: 2840, promotion_years: 4, annual_growth: 0.015, max_years: 22 }, 
            'M2': { rank: 'ä¸­æ ¡', base: 37310, pro_add: 55000, food_add: 2840, promotion_years: 4, annual_growth: 0.015, max_years: 26 }, 
            'M3': { rank: 'ä¸Šæ ¡', base: 41900, pro_add: 65000, food_add: 2840, promotion_years: 6, annual_growth: 0.015, max_years: 30 }, 
            
            // ã€å°‡å®˜ã€‘
            'G1': { rank: 'å°‘å°‡', base: 48030, pro_add: 70000, food_add: 2840, promotion_years: 4, annual_growth: 0.01, max_years: 35 }, 
            'G2': { rank: 'ä¸­å°‡', base: 53390, pro_add: 80000, food_add: 2840, promotion_years: 3, annual_growth: 0.01, max_years: 38 }, 
            'G3': { rank: 'äºŒç´šä¸Šå°‡', base: 109520, pro_add: 90000, food_add: 2840, promotion_years: Infinity, annual_growth: 0.01, max_years: 42 }
        };

        const RANK_ORDER = ['S2', 'S3', 'S4', 'M1', 'M2', 'M3', 'G1', 'G2', 'G3'];

        // å¿—é¡˜å½¹äººå“¡å›ºå®šåŠ çµ¦ (NT$15,000)
        const VOLUNTEER_ADDITION_2026 = 15000;

        // åœ‹è»é€€æ’«åŸºé‡‘ææ’¥ç‡ (14%ï¼Œå…¶ä¸­å€‹äººè² æ“” 35%)
        const PENSION_RATE = 0.14; 
        const INDIVIDUAL_PENSION_RATIO = 0.35; 

        // å…¨åŸŸè®Šæ•¸
        let financialChartInstance;
        let scenarioChartInstance;
        let allowanceCounter = 0;
        let lifeEventCounter = 0;

        // =========================================================
        // 2. ä»‹é¢äº’å‹•èˆ‡è¼”åŠ©å‡½æ•¸
        // =========================================================

        function formatCurrency(number) {
            if (isNaN(number)) return '--';
            const absNum = Math.abs(Math.round(number));
            const sign = number < 0 ? "-" : "";
            return `${sign}$${absNum.toLocaleString('zh-TW')}`;
        }

        // æ–°å¢éšæ®µæ€§åŠ çµ¦è¼¸å…¥æ¡†
        function addCustomAllowance() {
            allowanceCounter++;
            const container = document.getElementById('custom-allowances-container');
            const itemId = `custom-item-${allowanceCounter}`;
            
            let defaultName = "", defaultValue = 0, defaultStart = 1, defaultEnd = 5;
            if (allowanceCounter === 1 && container.children.length === 0) {
                defaultName = "ä¸»å®˜åŠ çµ¦"; defaultValue = 6000; defaultStart = 5; defaultEnd = 8;
            }

            const html = `
                <div id="${itemId}" class="grid grid-cols-12 gap-1 items-center allowance-row mb-2 text-xs bg-white p-1 rounded border border-gray-200 shadow-sm">
                    <div class="col-span-4"><input type="text" placeholder="é …ç›®" value="${defaultName}" class="w-full border-b border-gray-300 py-1 px-1 allow-name focus:outline-none" oninput="runSimulation()"></div>
                    <div class="col-span-3"><input type="number" placeholder="$" value="${defaultValue}" class="w-full border-b border-gray-300 py-1 px-1 allow-value focus:outline-none text-right" oninput="runSimulation()"></div>
                    <div class="col-span-2"><input type="number" placeholder="å§‹" value="${defaultStart}" class="w-full border-b border-gray-300 py-1 px-1 text-center allow-start bg-gray-50 focus:outline-none" oninput="runSimulation()"></div>
                    <div class="col-span-2"><input type="number" placeholder="æœ«" value="${defaultEnd}" class="w-full border-b border-gray-300 py-1 px-1 text-center allow-end bg-gray-50 focus:outline-none" oninput="runSimulation()"></div>
                    <div class="col-span-1 text-center"><button onclick="document.getElementById('${itemId}').remove(); runSimulation()" class="text-red-400 hover:text-red-600 font-bold">Ã—</button></div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

        // æ–°å¢äººç”Ÿå¤§äº‹è¼¸å…¥æ¡†
        function addLifeEvent() {
            lifeEventCounter++;
            const container = document.getElementById('life-events-container');
            const itemId = `life-event-${lifeEventCounter}`;
            
            let defaultName = "", defaultValue = 0, defaultYear = 5;
            if (lifeEventCounter === 1 && container.children.length === 0) {
                defaultName = "çµå©šè£œåŠ©"; defaultValue = 50000; defaultYear = 6;
            } else if (lifeEventCounter === 2) {
                defaultName = "è²·è»Šé ­æœŸ"; defaultValue = -200000; defaultYear = 8;
            }

            const html = `
                <div id="${itemId}" class="grid grid-cols-12 gap-1 items-center life-event-row mb-2 text-xs bg-white p-1 rounded border border-red-100 shadow-sm">
                    <div class="col-span-2 text-gray-400 pt-1 text-right pr-1 font-bold">Y</div>
                    <div class="col-span-2"><input type="number" value="${defaultYear}" class="w-full border-b border-gray-300 py-1 px-1 text-center event-year bg-red-50" oninput="runSimulation()"></div>
                    <div class="col-span-4 pl-2"><input type="text" placeholder="äº‹ä»¶" value="${defaultName}" class="w-full border-b border-gray-300 py-1 px-1 event-name" oninput="runSimulation()"></div>
                    <div class="col-span-3"><input type="number" placeholder="$" value="${defaultValue}" class="w-full border-b border-gray-300 py-1 px-1 event-amount text-right font-bold text-gray-700" oninput="runSimulation()"></div>
                    <div class="col-span-1 text-center"><button onclick="document.getElementById('${itemId}').remove(); runSimulation()" class="text-red-400 hover:text-red-600 font-bold">Ã—</button></div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

        // æ”¶é›†å‹•æ…‹è¼¸å…¥çš„è³‡æ–™
        function getConfigs() {
            const allowances = [];
            document.querySelectorAll('.allowance-row').forEach(row => {
                const amount = parseInt(row.querySelector('.allow-value').value) || 0;
                const start = parseInt(row.querySelector('.allow-start').value) || 1;
                const end = parseInt(row.querySelector('.allow-end').value) || 99;
                if(amount !== 0) allowances.push({amount, start, end});
            });

            const events = [];
            document.querySelectorAll('.life-event-row').forEach(row => {
                const year = parseInt(row.querySelector('.event-year').value) || 0;
                const amount = parseInt(row.querySelector('.event-amount').value) || 0;
                const name = row.querySelector('.event-name').value || 'æœªå‘½å';
                if(amount !== 0 && year > 0) events.push({year, amount, name});
            });

            return { allowances, events };
        }

        // =========================================================
        // 3. æ ¸å¿ƒæ¨¡æ“¬é‚è¼¯
        // =========================================================

        function runSimulation() {
            // å–å¾—ä½¿ç”¨è€…åƒæ•¸
            const targetRank = document.getElementById('targetRank').value;
            const serviceYearsInput = parseInt(document.getElementById('serviceYears').value) || 20;
            const monthlySavings = parseInt(document.getElementById('monthlySavings').value) || 0;
            const returnRate = parseFloat(document.getElementById('returnRate').value) / 100 || 0;
            const livingCost = parseInt(document.getElementById('livingCost').value) || 0;
            const bonusMonths = (parseFloat(document.getElementById('yearEndBonus').value) || 0) + (parseFloat(document.getElementById('perfBonus').value) || 0);

            const { allowances, events } = getConfigs();
            const targetRankIndex = RANK_ORDER.indexOf(targetRank);

            // è®Šæ•¸åˆå§‹åŒ–
            let currentAsset = 0;
            let currentRank = 'S2';
            let yearOfRank = 0;
            let forceRetired = false;
            let retiredYear = 0;
            
            // åœ–è¡¨èˆ‡å ±è¡¨æ•¸æ“šå®¹å™¨
            const yearsLabel = [];
            const netIncomeData = [];
            const assetData = [];
            const eventLog = [];

            // --- å¹´åº¦æ¨¡æ“¬è¿´åœˆ ---
            for (let year = 1; year <= serviceYearsInput; year++) {
                
                // A. å¼·åˆ¶é€€ä¼æª¢æŸ¥
                const currentRankData = REAL_SALARY_STRUCTURE[currentRank];
                if (year > currentRankData.max_years) {
                    forceRetired = true;
                    retiredYear = year - 1;
                    break; // åœæ­¢æ¨¡æ“¬
                }

                yearsLabel.push(`Y${year}`);

                // B. æ™‰å‡é‚è¼¯
                const currentIndex = RANK_ORDER.indexOf(currentRank);
                if (yearOfRank >= currentRankData.promotion_years && currentIndex < targetRankIndex) {
                    const nextRankIndex = currentIndex + 1;
                    if (nextRankIndex <= targetRankIndex) {
                        currentRank = RANK_ORDER[nextRankIndex];
                        yearOfRank = 0;
                    }
                }

                // C. æœˆè–ªè¨ˆç®—
                let yearAllowance = 0;
                allowances.forEach(conf => { if(year >= conf.start && year <= conf.end) yearAllowance += conf.amount; });

                const growthFactor = (1 + currentRankData.annual_growth) ** (year - 1);
                const pensionBase = (currentRankData.base + currentRankData.pro_add) * growthFactor;
                const grossMonthly = pensionBase + currentRankData.food_add + VOLUNTEER_ADDITION_2026 + yearAllowance;
                const pensionDeduction = pensionBase * PENSION_RATE * INDIVIDUAL_PENSION_RATIO;
                const netMonthly = Math.round(grossMonthly - pensionDeduction);

                // D. å¹´åº¦ç¾é‡‘æµè¨ˆç®—
                let annualIncome = netMonthly * 12;
                const annualBonus = Math.round(pensionBase * bonusMonths);
                annualIncome += annualBonus;

                let eventEffect = 0;
                let eventDesc = "";
                events.forEach(e => {
                    if (e.year === year) {
                        eventEffect += e.amount;
                        eventDesc += `${e.name}(${e.amount > 0 ? '+' : ''}${Math.round(e.amount/10000)}è¬) `;
                    }
                });
                annualIncome += eventEffect;

                // E. æ”¯å‡ºèˆ‡å„²è“„
                const annualExpense = livingCost * 12;
                const fixedSavings = monthlySavings * 12;
                const netCashflow = annualIncome - annualExpense - fixedSavings;

                // F. è³‡ç”¢è¤‡åˆ©è¨ˆç®—
                currentAsset = currentAsset * (1 + returnRate) + fixedSavings + netCashflow;

                // æ•¸æ“šå„²å­˜
                netIncomeData.push(netMonthly); 
                assetData.push(Math.round(currentAsset));
                
                eventLog.push({
                    year: year,
                    rank: REAL_SALARY_STRUCTURE[currentRank].rank,
                    net: netCashflow,
                    event: eventDesc,
                    status: netCashflow < 0 ? 'âš ï¸ é€æ”¯' : 'âœ… çµé¤˜'
                });

                yearOfRank++;
            }

            // --- çµ‚èº«ä¿¸è©¦ç®— ---
            let finalRankData = REAL_SALARY_STRUCTURE[currentRank];
            let actualServiceYears = forceRetired ? retiredYear : serviceYearsInput;
            let pensionMonthly = 0;
            let pensionEligible = actualServiceYears >= 20;

            if (pensionEligible) {
                const baseForPension = finalRankData.base * ((1 + finalRankData.annual_growth) ** (actualServiceYears - 1));
                const ratio = 0.55 + (actualServiceYears - 20) * 0.02;
                pensionMonthly = Math.round(baseForPension * 2 * ratio);
            }

            // --- æ›´æ–° UI é¡¯ç¤º ---
            document.getElementById('total-asset').innerText = formatCurrency(currentAsset);
            
            const pensionEl = document.getElementById('pension-monthly');
            const pensionSubEl = document.getElementById('pension-sub');
            if (pensionEligible) {
                pensionEl.innerText = formatCurrency(pensionMonthly);
                pensionEl.className = "text-3xl font-serif font-black text-green-700 mt-1";
                pensionSubEl.innerText = `æœå½¹ ${actualServiceYears} å¹´ï¼Œç¬¦åˆè³‡æ ¼`;
            } else {
                pensionEl.innerText = "æœªé”é–€æª»";
                pensionEl.className = "text-xl font-bold text-gray-400 mt-1";
                pensionSubEl.innerText = `åƒ…æœå½¹ ${actualServiceYears} å¹´ (éœ€ 20 å¹´)`;
            }

            const statusText = document.getElementById('status-text');
            const statusBar = document.getElementById('status-bar');
            const finalStatusEl = document.getElementById('final-status');
            
            if (forceRetired) {
                statusBar.classList.remove('hidden');
                statusText.innerText = `è­¦å‘Šï¼šæ‚¨åœ¨ç¬¬ ${retiredYear} å¹´å› é”åˆ°ã€${REAL_SALARY_STRUCTURE[currentRank].rank}ã€‘æœ€å¤§æœå½¹å¹´é™è€Œå¼·åˆ¶é€€ä¼ã€‚`;
                finalStatusEl.innerText = `å¼·åˆ¶é€€ä¼ (${REAL_SALARY_STRUCTURE[currentRank].rank})`;
                finalStatusEl.className = "text-xl font-bold text-military-red mt-1";
            } else {
                statusBar.classList.add('hidden');
                finalStatusEl.innerText = `å…‰æ¦®é€€ä¼ (${REAL_SALARY_STRUCTURE[currentRank].rank})`;
                finalStatusEl.className = "text-xl font-bold text-military-900 mt-1";
            }

            const tbody = document.getElementById('event-log-body');
            tbody.innerHTML = '';
            eventLog.forEach(log => {
                const row = `<tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-4 py-2 font-mono text-gray-500">Y${log.year}</td>
                    <td class="px-4 py-2 font-bold text-military-900">${log.rank}</td>
                    <td class="px-4 py-2 ${log.net < 0 ? 'text-red-600 font-bold' : 'text-green-600'}">${formatCurrency(log.net)}</td>
                    <td class="px-4 py-2 text-xs text-gray-600">${log.event || '-'}</td>
                    <td class="px-4 py-2 text-xs">${log.status}</td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });

            renderCharts(yearsLabel, netIncomeData, assetData, monthlySavings, actualServiceYears);
        }

        // =========================================================
        // 4. åœ–è¡¨ç¹ªè£½
        // =========================================================

        function renderCharts(labels, salaryData, assetData, monthlySavings, actualYears) {
            Chart.defaults.font.family = '"Noto Sans TC", sans-serif';

            // åœ–è¡¨ 1: è–ªè³‡èˆ‡è³‡ç”¢
            if (financialChartInstance) financialChartInstance.destroy();
            const ctx1 = document.getElementById('financialChart').getContext('2d');
            financialChartInstance = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'æœˆæ·¨è–ªè³‡', data: salaryData, borderColor: '#1a2e45', backgroundColor:'#1a2e45', yAxisID: 'y1', tension: 0.1 },
                        { label: 'ç´¯ç©è³‡ç”¢', data: assetData, borderColor: '#c5a065', backgroundColor: 'rgba(197, 160, 101, 0.1)', fill: true, yAxisID: 'y2', tension: 0.3 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y1: { position: 'left', title: {display: true, text: 'æœˆè–ª (å…ƒ)'}, grid: { color: '#f3f4f6' } },
                        y2: { position: 'right', title: {display: true, text: 'ç¸½è³‡ç”¢ (å…ƒ)'}, grid: {drawOnChartArea: false} }
                    }
                }
            });

            // åœ–è¡¨ 2: æŠ•è³‡æƒ…å¢ƒ
            if (scenarioChartInstance) scenarioChartInstance.destroy();
            
            const calculateScenario = (rate) => {
                let val = 0;
                const data = [];
                for(let i=0; i<actualYears; i++) {
                    val = val * (1 + rate) + (monthlySavings * 12);
                    data.push(val);
                }
                return data;
            }
            
            const baseRate = parseFloat(document.getElementById('returnRate').value) / 100 || 0.05;
            const lowData = calculateScenario(0.02);
            const midData = calculateScenario(baseRate);
            const highData = calculateScenario(0.08);

            const ctx2 = document.getElementById('scenarioChart').getContext('2d');
            scenarioChartInstance = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ä¿å®ˆ (2%)', data: lowData, borderColor: '#64748b', tension: 0.2, pointRadius: 0 },
                        { label: `ç›®å‰è¨­å®š (${(baseRate*100).toFixed(1)}%)`, data: midData, borderColor: '#3b82f6', borderWidth: 3, tension: 0.2 },
                        { label: 'ç©æ¥µ (8%)', data: highData, borderColor: '#f43f5e', tension: 0.2, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }

        // ç³»çµ±åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            addCustomAllowance();
            addLifeEvent();
            
            document.body.addEventListener('input', (e) => {
                if(e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                    runSimulation();
                }
            });

            runSimulation();
        });
    </script>
</body>
</html>
