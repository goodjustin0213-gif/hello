<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è»äººè·æ¶¯è–ªè³‡è¦åŠƒæ±ºç­–æ”¯æ´ç³»çµ± - æœ€çµ‚ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* CSS æ¨£å¼ä¿æŒä¸è®Š */
        body { background-color: #f7f9fc; }
        .scrollable-content { min-height: calc(100vh - 8rem); }
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>
    <header class="bg-indigo-800 text-white p-4 shadow-lg sticky top-0 z-10">
        <h1 class="text-2xl font-extrabold tracking-wide">ğŸš€ è»äººè·æ¶¯è²¡å‹™æ±ºç­–æ”¯æ´ç³»çµ±</h1>
        <p class="text-indigo-200 text-sm mt-1">æ¨¡æ“¬åœ‹è»è–ªè³‡èˆ‡è³‡ç”¢ç´¯ç© (å·²ç´å…¥å°‡ç´šè»å®˜æ¨¡æ“¬æ•¸æ“š)ã€‚</p>
    </header>

    <main class="flex flex-col lg:flex-row min-h-screen">
        <aside id="input-parameters" class="w-full lg:w-1/4 p-6 bg-white border-r border-gray-200 shadow-xl">
            <h2 class="text-xl font-bold mb-4 text-indigo-700">âš™ï¸ è²¡å‹™æ¨¡æ“¬åƒæ•¸è¨­å®š</h2>
            
            <div class="mb-5 border-b pb-4">
                <h3 class="font-semibold text-gray-700 mb-2">1. è»æ—…ç”Ÿæ¶¯å‡è¨­ (èµ·å§‹éšç´šå›ºå®šç‚ºå°‘å°‰ S2)</h3>
                
                <label for="targetRank" class="block text-sm font-medium text-gray-600">æœ€çµ‚ç›®æ¨™éšç´š (æœ€é«˜æ™‰å‡ä½éš)</label>
                <select id="targetRank" class="mt-1 block w-full border rounded-md py-2 px-3">
                    <option value="S2">å°‘å°‰ (S2)</option>
                    <option value="S3">ä¸­å°‰ (S3)</option>
                    <option value="S4">ä¸Šå°‰ (S4)</option>
                    <option value="M1">å°‘æ ¡ (M1)</option>
                    <option value="M2">ä¸­æ ¡ (M2)</option>
                    <option value="M3">ä¸Šæ ¡ (M3)</option>
                    <option value="S5">å°‘å°‡ (S5)</option>
                    <option value="S6">ä¸­å°‡ (S6)</option>
                    <option value="S7">ä¸Šå°‡ (S7)</option>
                </select>
                
                <label for="serviceYears" class="block text-sm font-medium text-gray-600 mt-3">é è¨ˆæœå½¹ç¸½å¹´æ•¸ (10-35å¹´)</label>
                <input type="number" id="serviceYears" value="20" min="10" max="35" class="mt-1 block w-full border rounded-md py-2 px-3">
            </div>

            <div class="mb-5 border-b pb-4">
                <h3 class="font-semibold text-gray-700 mb-2">2. æ‰€æœ‰é¡å¤–åŠ çµ¦èˆ‡æ´¥è²¼ (æœˆé¡)</h3>
                <p class="text-xs text-indigo-500 mb-2">è«‹æ ¹æ“šæ‚¨çš„è·å‹™è‡ªè¡Œå¡«å¯«æ‰€æœ‰åŠ çµ¦ç¸½é¡ã€‚</p>
                <p class="text-xs text-indigo-500 mb-2">è¨»ï¼šå·²è‡ªå‹•åŒ…å« 2026 å¹´å¿—é¡˜å½¹åŠ çµ¦ 30,000 å…ƒã€‚</p>
                
                <label class="block text-sm font-medium text-gray-600 mt-3">åŠ çµ¦é …ç›®åç¨±èˆ‡é‡‘é¡ (ä¾‹å¦‚: é ˜å°åŠ çµ¦, å¤–å³¶åŠ çµ¦)</label>
                <div id="custom-allowances-container" class="space-y-2 mt-1">
                    </div>
                <button type="button" onclick="addCustomAllowance()" class="w-full bg-indigo-100 text-indigo-700 text-sm font-semibold py-1 mt-2 rounded-md hover:bg-indigo-200 transition duration-150">
                    + æ–°å¢åŠ çµ¦é …ç›®
                </button>
            </div>

            <div class="mb-5 border-b pb-4">
                <h3 class="font-semibold text-gray-700 mb-2">3. ç†è²¡ç­–ç•¥å‡è¨­</h3>
                <label for="savingsRate" class="block text-sm font-medium text-gray-600">æ¯æœˆè–ªè³‡å„²è“„/æŠ•è³‡æ¯”ä¾‹ (%)</label>
                <input type="number" id="savingsRate" value="30" min="5" max="90" class="mt-1 block w-full border rounded-md py-2 px-3">
                <label for="returnRate" class="block text-sm font-medium text-gray-600 mt-3">å¹´åŒ–å¹³å‡æŠ•è³‡å ±é…¬ç‡å‡è¨­ (%)</label>
                <input type="number" id="returnRate" value="5" min="0" max="15" step="0.1" class="mt-1 block w-full border rounded-md py-2 px-3">
            </div>

            <div class="mb-5">
                <h3 class="font-semibold text-gray-700 mb-2">4. åŸºæœ¬ç”Ÿæ´»æ”¯å‡ºå‡è¨­</h3>
                <label for="livingCost" class="block text-sm font-medium text-gray-600">æ¯æœˆåŸºæœ¬ç”Ÿæ´»æ”¯å‡º (å…ƒ)</label>
                <input type="number" id="livingCost" value="15000" class="mt-1 block w-full border rounded-md py-2 px-3">
            </div>

            <button onclick="runSimulation()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-150">
                ğŸš€ åŸ·è¡Œè²¡å‹™æ±ºç­–æ¨¡æ“¬
            </button>
            <p id="simulation-status" class="mt-4 text-center text-sm text-red-500 font-semibold hidden">
                è«‹å…ˆè¼¸å…¥åƒæ•¸ä¸¦é»æ“ŠæŒ‰éˆ•ã€‚
            </p>
        </aside>

        <section class="w-full lg:w-3/4 p-6 scrollable-content">
            
            <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white p-5 rounded-lg shadow-md border-t-4 border-indigo-500">
                    <p class="text-sm text-gray-500">é è¨ˆæœå½¹æœŸç¸½è³‡ç”¢ç´¯ç©</p>
                    <p id="total-asset" class="text-3xl font-extrabold text-indigo-800 mt-1">--</p>
                    <p class="text-xs text-gray-400 mt-1">å„²è“„èˆ‡æŠ•è³‡è¤‡åˆ©æˆæœ</p>
                </div>
                <div class="bg-white p-5 rounded-lg shadow-md border-t-4 border-orange-500">
                    <p class="text-sm text-gray-500">æœå½¹æœŸé–“å¹³å‡æœˆæ·¨ç¾é‡‘æµ</p>
                    <p id="avg-cashflow" class="text-3xl font-extrabold text-orange-800 mt-1">--</p>
                    <p class="text-xs text-gray-400 mt-1">æ‰£é™¤æ”¯å‡ºèˆ‡æŠ•è³‡å¾Œçš„é¤˜è£•</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-bold text-gray-700 mb-4">ğŸ“ˆ è–ªè³‡æˆé•·èˆ‡è³‡ç”¢ç´¯ç©èµ°å‹¢åœ–</h2>
                <canvas id="financialChart"></canvas>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-gray-700 mb-4">ğŸ’° ä¸åŒæŠ•è³‡ç­–ç•¥ä¸‹çš„è³‡ç”¢æƒ…å¢ƒæ¯”è¼ƒ</h2>
                <canvas id="scenarioChart"></canvas>
            </div>

        </section>
    </main>
    
    <script>
        // =========================================================
        // MOCK DATA: åœ‹è»è»å®˜è–ªè³‡çµæ§‹ (è«‹æ›¿æ›ç‚ºçœŸå¯¦æ•¸æ“š)
        // =========================================================
        const REAL_SALARY_STRUCTURE = {
            // å°‰/æ ¡ç´šè»å®˜
            'S2': { rank: 'å°‘å°‰', base: 26000, pro_add: 28000, food_add: 2840, promotion_years: 3, annual_growth: 0.015 },
            'S3': { rank: 'ä¸­å°‰', base: 28000, pro_add: 30000, food_add: 2840, promotion_years: 4, annual_growth: 0.015 },
            'S4': { rank: 'ä¸Šå°‰', base: 31000, pro_add: 35000, food_add: 2840, promotion_years: 7, annual_growth: 0.015 },
            'M1': { rank: 'å°‘æ ¡', base: 38000, pro_add: 45000, food_add: 2840, promotion_years: 6, annual_growth: 0.015 },
            'M2': { rank: 'ä¸­æ ¡', base: 45000, pro_add: 55000, food_add: 2840, promotion_years: 6, annual_growth: 0.015 },
            'M3': { rank: 'ä¸Šæ ¡', base: 52000, pro_add: 65000, food_add: 2840, promotion_years: 5, annual_growth: 0.015 },
            // å°‡ç´šè»å®˜ (æ¨¡æ“¬æ•¸æ“š)
            'S5': { rank: 'å°‘å°‡', base: 60000, pro_add: 75000, food_add: 2840, promotion_years: 4, annual_growth: 0.015 },
            'S6': { rank: 'ä¸­å°‡', base: 70000, pro_add: 85000, food_add: 2840, promotion_years: 3, annual_growth: 0.015 },
            'S7': { rank: 'ä¸Šå°‡', base: 80000, pro_add: 95000, food_add: 2840, promotion_years: Infinity, annual_growth: 0.015 },
        };

        const RANK_ORDER = ['S2', 'S3', 'S4', 'M1', 'M2', 'M3', 'S5', 'S6', 'S7']; // æ›´æ–°æ’åº
        // 2026å¹´èµ·å¿—é¡˜å½¹äººå“¡å›ºå®šåŠ çµ¦ (NT$30,000)
        const VOLUNTEER_ADDITION_2026 = 30000; 

        let financialChartInstance;
        let scenarioChartInstance;
        let allowanceCounter = 0; // ç”¨æ–¼è¿½è¹¤è‡ªè¨‚åŠ çµ¦é …ç›®çš„ ID

        // --- è¼”åŠ©å‡½æ•¸ ---

        function formatCurrency(number) {
            if (isNaN(number) || number === 0) return '--';
            return `NT$ ${Math.round(number).toLocaleString('zh-TW')}`;
        }

        /**
         * æ–°å¢ä¸€çµ„è‡ªè¨‚åŠ çµ¦è¼¸å…¥æ¡† (åç¨±+é‡‘é¡)
         */
        function addCustomAllowance() {
            allowanceCounter++;
            const container = document.getElementById('custom-allowances-container');
            const itemId = `custom-item-${allowanceCounter}`;

            const newAllowanceHtml = `
                <div id="${itemId}" class="flex space-x-2 items-center">
                    <input type="text" placeholder="é …ç›®åç¨± (ä¾‹å¦‚: è¶…æ™‚åŠ çµ¦)" class="w-2/3 border rounded-md py-1 px-2 text-sm">
                    <input type="number" placeholder="é‡‘é¡ (å…ƒ/æœˆ)" value="0" class="w-1/3 border rounded-md py-1 px-2 text-sm allowance-value">
                    <button type="button" onclick="document.getElementById('${itemId}').remove()" class="text-red-500 hover:text-red-700 text-lg font-bold">
                        &times;
                    </button>
                </div>
            `;
            requestAnimationFrame(() => {
                container.insertAdjacentHTML('beforeend', newAllowanceHtml);
            });
        }

        /**
         * è¨ˆç®—æ‰€æœ‰è‡ªè¨‚åŠ çµ¦è¼¸å…¥æ¡†çš„ç¸½å’Œ (é¿å…ç©ºå€¼éŒ¯èª¤)
         */
        function calculateCustomAllowanceTotal() {
            const allowanceInputs = document.querySelectorAll('.allowance-value');
            let total = 0;
            allowanceInputs.forEach(input => {
                const value = parseInt(input.value) || 0; 
                total += value;
            });
            return total;
        }

        /**
         * æ ¹æ“šéšç´šã€å¹´è³‡ã€åŠè‡ªè¨‚æ´¥è²¼è¨ˆç®—ç•¶å‰æœˆè–ªç¸½é¡
         */
        function calculateMonthlySalary(rankCode, year, customAdd) {
            const data = REAL_SALARY_STRUCTURE[rankCode];
            if (!data) return 0;
            
            // 1. åŸºç¤æœˆè–ª (æœ¬ä¿¸ + å°ˆæ¥­åŠ çµ¦ + ä¼™é£Ÿæ´¥è²¼)
            let monthlyTotal = data.base + data.pro_add + data.food_add;
            
            // 2. åŠ ä¸Š 2026å¹´èµ·å¿—é¡˜å½¹å›ºå®šåŠ çµ¦ (NT$30,000)
            monthlyTotal += VOLUNTEER_ADDITION_2026;
            
            // 3. åŠ ä¸Šä½¿ç”¨è€…è¼¸å…¥çš„æ‰€æœ‰è‡ªè¨‚åŠ çµ¦
            monthlyTotal += customAdd;
            
            // 4. è€ƒæ…®å¹´åº¦åŸºç¤æˆé•·
            monthlyTotal *= (1 + data.annual_growth) ** (year - 1);
            
            return Math.round(monthlyTotal);
        }

        function renderFinancialChart(years, salaryData, assetData) {
            if (financialChartInstance) financialChartInstance.destroy();
            
            const ctx = document.getElementById('financialChart').getContext('2d');
            financialChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'æ¯æœˆè–ªè³‡ç¸½é¡ (NT$)',
                            data: salaryData,
                            borderColor: 'rgb(79, 70, 229)', 
                            yAxisID: 'y1',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'ç´¯ç©è³‡ç”¢ç¸½é¡ (NT$)',
                            data: assetData,
                            borderColor: 'rgb(20, 184, 166)', 
                            yAxisID: 'y2',
                            fill: true,
                            backgroundColor: 'rgba(20, 184, 166, 0.2)',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'æœˆè–ªç¸½é¡ (å…ƒ)' }
                        },
                        y2: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'ç´¯ç©è³‡ç”¢ç¸½é¡ (å…ƒ)' },
                            grid: { drawOnChartArea: false }
                        }
                    },
                    plugins: { title: { display: true, text: 'è»æ—…ç”Ÿæ¶¯è²¡å‹™é æ¸¬ (è–ªè³‡èˆ‡è³‡ç”¢ç´¯ç©)' } }
                }
            });
        }

        function renderScenarioChart(years, baseSalaryData, livingCost, savingsRate) {
            if (scenarioChartInstance) scenarioChartInstance.destroy();

            const lowRate = 0.02; 
            const highRate = 0.08; 
            const baseRate = parseFloat(document.getElementById('returnRate').value) / 100 || 0;

            const calcScenarioAsset = (rate) => {
                let asset = 0;
                const data = [];
                
                for (let i = 0; i < baseSalaryData.length; i++) {
                    const monthlySalary = baseSalaryData[i];
                    const annualSalary = monthlySalary * 12;
                    const annualLivingCost = livingCost * 12;
                    const annualNetIncome = Math.max(0, annualSalary - annualLivingCost); 
                    const annualSavingsInvestment = annualNetIncome * savingsRate;
                    
                    asset = asset * (1 + rate) + annualSavingsInvestment;
                    data.push(asset);
                }
                return data;
            };
            
            const baseAsset = calcScenarioAsset(baseRate);
            const lowAsset = calcScenarioAsset(lowRate);
            const highAsset = calcScenarioAsset(highAsset);

            const ctx = document.getElementById('scenarioChart').getContext('2d');
            scenarioChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: `ä½é¢¨éšªè³‡ç”¢ç´¯ç© (å ±é…¬ç‡ ${lowRate * 100}%)`,
                            data: lowAsset,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            tension: 0.2,
                        },
                        {
                            label: `æ‚¨çš„å‡è¨­æƒ…å¢ƒ (å ±é…¬ç‡ ${baseRate * 100}%)`,
                            data: baseAsset,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderWidth: 3,
                            tension: 0.2,
                        },
                        {
                            label: `é«˜é¢¨éšªè³‡ç”¢ç´¯ç© (å ±é…¬ç‡ ${highRate * 100}%)`,
                            data: highAsset,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            tension: 0.2,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: { y: { title: { display: true, text: 'ç´¯ç©è³‡ç”¢ç¸½é¡ (å…ƒ)' } } },
                    plugins: { title: { display: true, text: 'ä¸åŒæŠ•è³‡å ±é…¬ç‡ä¸‹çš„è³‡ç”¢ç´¯ç©æƒ…å¢ƒæ¯”è¼ƒ' } }
                }
            });
        }

        /**
         * åŸ·è¡Œæ ¸å¿ƒè²¡å‹™æ¨¡æ“¬é‹ç®— (ä¸»è¦å‡½æ•¸)
         */
        function runSimulation() {
            // 1. å–å¾—ä½¿ç”¨è€…è¼¸å…¥åƒæ•¸
            const targetRank = document.getElementById('targetRank').value;
            const serviceYears = parseInt(document.getElementById('serviceYears').value) || 0;
            const savingsRate = parseFloat(document.getElementById('savingsRate').value) / 100 || 0;
            const returnRate = parseFloat(document.getElementById('returnRate').value) / 100 || 0;
            const livingCost = parseInt(document.getElementById('livingCost').value) || 0;
            
            // ç²å–æ‰€æœ‰è‡ªè¨‚åŠ çµ¦çš„ç¸½å’Œ
            const customAllowance = calculateCustomAllowanceTotal(); 
            
            if (serviceYears < 10 || isNaN(serviceYears) || isNaN(livingCost)) {
                document.getElementById('simulation-status').innerText = 'è«‹ç¢ºèªæœå½¹å¹´æ•¸èˆ‡æ”¯å‡ºè¼¸å…¥æ­£ç¢ºã€‚';
                document.getElementById('simulation-status').classList.remove('hidden');
                return;
            }
            document.getElementById('simulation-status').classList.add('hidden');

            // 2. æ ¸å¿ƒè¨ˆç®—è¿´åœˆåˆå§‹åŒ–
            let currentAsset = 0;
            let currentRank = 'S2'; 
            let yearOfRank = 0; 
            let totalCashFlow = 0;
            
            const years = [];
            const monthlySalaryData = [];
            const totalAssetData = [];
            
            const targetRankIndex = RANK_ORDER.indexOf(targetRank); 

            for (let year = 1; year <= serviceYears; year++) {
                years.push(`ç¬¬ ${year} å¹´`);

                // æª¢æŸ¥æ™‰å‡é‚è¼¯ï¼š
                const currentRankData = REAL_SALARY_STRUCTURE[currentRank];
                const currentIndex = RANK_ORDER.indexOf(currentRank);
                
                if (yearOfRank >= currentRankData.promotion_years && currentIndex < targetRankIndex) {
                    
                    const nextRankIndex = currentIndex + 1;
                    if (nextRankIndex <= targetRankIndex) { 
                        currentRank = RANK_ORDER[nextRankIndex];
                        yearOfRank = 0; 
                    }
                }
                
                // ç²å–ç•¶å‰æœˆè–ª
                let monthlySalary = calculateMonthlySalary(currentRank, year, customAllowance);
                monthlySalaryData.push(monthlySalary);

                // è²¡å‹™è¨ˆç®—
                const annualSalary = monthlySalary * 12;
                const annualLivingCost = livingCost * 12;
                
                const annualNetIncome = Math.max(0, annualSalary - annualLivingCost); 
                
                const annualSavingsInvestment = annualNetIncome * savingsRate;
                const annualRemainingCash = annualNetIncome * (1 - savingsRate);
                
                totalCashFlow += annualRemainingCash;
                currentAsset = currentAsset * (1 + returnRate) + annualSavingsInvestment;
                totalAssetData.push(currentAsset);
                
                yearOfRank++; 
            }

            // 3. è¼¸å‡ºæ ¸å¿ƒæ•¸æ“š
            const finalAsset = totalAssetData[totalAssetData.length - 1] || 0;
            const avgMonthlyCashFlow = totalCashFlow / serviceYears / 12 || 0;
            
            document.getElementById('total-asset').innerText = formatCurrency(finalAsset);
            document.getElementById('avg-cashflow').innerText = formatCurrency(avgMonthlyCashFlow);
            
            // 4. ç¹ªè£½åœ–è¡¨
            renderFinancialChart(years, monthlySalaryData, totalAssetData);
            renderScenarioChart(years, monthlySalaryData, livingCost, savingsRate);
        }

        // ç³»çµ±å•Ÿå‹•æ™‚çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // æª¢æŸ¥è‡ªè¨‚åŠ çµ¦å®¹å™¨æ˜¯å¦ç‚ºç©ºï¼Œå¦‚æœç‚ºç©ºï¼Œå‰‡é è¨­æ–°å¢ä¸€å€‹è¼¸å…¥æ¡†
            const container = document.getElementById('custom-allowances-container');
            if (container.children.length === 0) {
                addCustomAllowance();
            }
            // é‹è¡Œåˆå§‹æ¨¡æ“¬
            runSimulation();
        });
