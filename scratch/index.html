<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國軍財務戰情室 v24.0 (最終穩定版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #f1f5f9; color: #1e293b; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .mono { font-family: 'Roboto Mono', monospace; }
        
        /* 側邊欄 */
        aside { width: 400px; background: white; border-right: 1px solid #cbd5e1; display: flex; flex-direction: column; z-index: 20; overflow-y: auto; height: 100%; box-shadow: 4px 0 10px rgba(0,0,0,0.05); }
        main { flex: 1; overflow-y: auto; padding: 20px; background: #f8fafc; }

        /* 輸入區 */
        .section { padding: 15px; border-bottom: 1px solid #f1f5f9; }
        .sec-title { font-size: 0.9rem; font-weight: 700; color: #334155; margin-bottom: 10px; border-left: 4px solid #2563eb; padding-left: 8px; }
        
        label { display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 4px; }
        input, select { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; background: #fff; }
        input:focus { outline: 2px solid #2563eb; border-color: transparent; }

        /* A/B 切換 */
        .tab-box { display: flex; background: #e2e8f0; p-1; border-radius: 8px; margin: 10px; }
        .tab { flex: 1; text-align: center; padding: 8px; cursor: pointer; font-weight: 700; font-size: 0.9rem; border-radius: 6px; color: #64748b; }
        .tab.active { background: white; color: #2563eb; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* 卡片 */
        .card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); margin-bottom: 20px; }
        .kpi-val { font-size: 1.8rem; font-weight: 900; font-family: 'Roboto Mono'; }

        /* 列表 */
        .item-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .btn-add { width: 100%; padding: 6px; border: 1px dashed #94a3b8; color: #64748b; font-size: 0.8rem; border-radius: 6px; font-weight: 700; margin-top: 5px; cursor: pointer; }
        .btn-add:hover { border-color: #2563eb; color: #2563eb; background: #eff6ff; }
        .btn-del { color: #ef4444; font-weight: bold; cursor: pointer; padding: 0 8px; display: flex; align-items: center; }
    </style>
</head>
<body>

<div class="flex h-full">
    <aside>
        <div class="p-4 bg-slate-900 text-white shrink-0">
            <h1 class="font-black text-lg">國軍財務戰情室 v24.0</h1>
            <p class="text-xs text-slate-400">最終穩定版 | Real-time Calculation</p>
        </div>

        <div class="tab-box">
            <div id="tab-A" class="tab active" onclick="APP.switchTab('A')">方案 A</div>
            <div id="tab-B" class="tab" onclick="APP.switchTab('B')">方案 B (對照)</div>
        </div>

        <div id="input-container">
            <div class="section">
                <div class="sec-title">1. 職涯與薪資</div>
                <div class="mb-3">
                    <label>目前階級 (起點)</label>
                    <select id="currentRank" onchange="APP.update()"></select>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div><label>目標階級</label><select id="targetRank" onchange="APP.update()"></select></div>
                    <div><label>再服役年數</label><input type="number" id="years" value="20" oninput="APP.update()"></div>
                </div>
                <div class="bg-blue-50 p-2 rounded border border-blue-200 mb-2">
                    <label class="text-blue-800">★ 實領月薪 (若輸入則以此為準)</label>
                    <input type="number" id="realPay" value="0" class="font-bold text-blue-700" oninput="APP.update()">
                </div>
                <label>額外加給 (如: 勤務/戰鬥/外島)</label>
                <div id="list-allowance"></div>
                <button class="btn-add" onclick="APP.add('list-allowance')">+ 新增加給</button>
            </div>

            <div class="section">
                <div class="sec-title">2. 生活支出</div>
                <div class="mb-2"><label>基本月開銷 (食衣住行)</label><input type="number" id="livingCost" value="15000" oninput="APP.update()"></div>
                <div class="mb-2"><label>固定支出 (保險/孝親)</label><input type="number" id="fixedCost" value="5000" oninput="APP.update()"></div>
                <label>額外支出 (車貸/信貸)</label>
                <div id="list-expense"></div>
                <button class="btn-add" onclick="APP.add('list-expense')">+ 新增支出</button>
            </div>

            <div class="section">
                <div class="sec-title">3. 投資理財</div>
                <div class="mb-3">
                    <div class="flex justify-between"><label>月薪提撥率</label><span id="rateLabel" class="text-blue-600 font-bold">30%</span></div>
                    <input type="range" id="investRate" min="0" max="90" value="30" oninput="document.getElementById('rateLabel').innerText=this.value+'%'; APP.update()">
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div><label>年化報酬(%)</label><input type="number" id="roi" value="6.0" oninput="APP.update()"></div>
                    <div><label>通膨率(%)</label><input type="number" id="inflation" value="2.0" oninput="APP.update()"></div>
                </div>
                <label>定期定額 (固定金額)</label>
                <div id="list-invest"></div>
                <button class="btn-add" onclick="APP.add('list-invest')">+ 新增定投</button>
            </div>

            <div class="section">
                <div class="sec-title flex justify-between">
                    4. 房產模擬
                    <input type="checkbox" id="buyHouse" class="w-4 h-4" onchange="APP.update()">
                </div>
                <div id="housing-area" class="hidden space-y-2 text-sm">
                    <div><label>第 N 年買房</label><input type="number" id="buyYear" value="10" oninput="APP.update()"></div>
                    <div><label>房屋總價 (萬)</label><input type="number" id="housePrice" value="1200" oninput="APP.update()"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label>頭期款(%)</label><input type="number" id="downPayment" value="20" oninput="APP.update()"></div>
                        <div><label>年限(年)</label><input type="number" id="loanYears" value="30" oninput="APP.update()"></div>
                    </div>
                </div>
            </div>
            <div class="h-20"></div>
        </div>
    </aside>

    <main>
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="card border-l-4 border-blue-600">
                <div class="text-xs font-bold text-gray-400 uppercase">方案 A 淨資產</div>
                <div class="kpi-val text-blue-700" id="kpi-A">--</div>
            </div>
            <div class="card border-l-4 border-gray-400">
                <div class="text-xs font-bold text-gray-400 uppercase">方案 B 淨資產</div>
                <div class="kpi-val text-gray-600" id="kpi-B">--</div>
            </div>
            <div class="card border-l-4 border-emerald-500">
                <div class="text-xs font-bold text-gray-400 uppercase">效益差異 (A-B)</div>
                <div class="kpi-val text-emerald-600" id="kpi-diff">--</div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="card">
                <h3 class="font-bold text-gray-700 mb-2">資產累積對照</h3>
                <div class="relative h-64"><canvas id="chart-asset"></canvas></div>
            </div>
            <div class="card">
                <h3 class="font-bold text-gray-700 mb-2">方案 A 資產結構</h3>
                <div class="relative h-64"><canvas id="chart-wealth"></canvas></div>
            </div>
        </div>

        <div class="card p-0 overflow-hidden">
            <div class="p-3 bg-gray-100 font-bold text-gray-700 border-b">方案 A 詳細明細 (單位:元)</div>
            <div class="overflow-x-auto max-h-[400px]">
                <table class="w-full text-sm text-left">
                    <thead class="bg-white text-gray-500 sticky top-0 shadow-sm">
                        <tr>
                            <th class="p-3 text-center">年</th>
                            <th class="p-3">階級</th>
                            <th class="p-3 text-right">年收入</th>
                            <th class="p-3 text-right text-red-500">總支出</th>
                            <th class="p-3 text-right text-emerald-600">投入投資</th>
                            <th class="p-3 text-right text-orange-500">房貸</th>
                            <th class="p-3 text-right font-black">淨資產</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y text-gray-700"></tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<script>
/**
 * 國軍財務系統核心 V24.0 (Final Stable)
 * 修正策略：直接讀取 DOM，移除複雜的暫存邏輯，確保計算絕對同步。
 */
const APP = {
    currentTab: 'A',
    // 資料暫存區 (只用來存切換時的數據)
    store: { A: {}, B: {} },
    charts: {},

    // 2025 薪資 (本俸+專業)
    rankData: {
        '二兵': {b:10550, p:0}, '一兵': {b:11130, p:0}, '上兵': {b:12280, p:0},
        '下士': {b:14645, p:5500}, '中士': {b:16585, p:6200}, '上士': {b:18525, p:7000},
        '三等士官長': {b:22750, p:8200}, '二等士官長': {b:25050, p:9500}, '一等士官長': {b:28880, p:10800},
        '少尉': {b:22750, p:8500}, '中尉': {b:25050, p:9800}, '上尉': {b:28880, p:11500},
        '少校': {b:32710, p:23000}, '中校': {b:37310, p:26000}, '上校': {b:41900, p:32000}, '少將': {b:48030, p:40000}
    },
    ranks: ['二兵','一兵','上兵','下士','中士','上士','三等士官長','二等士官長','一等士官長','少尉','中尉','上尉','少校','中校','上校','少將'],

    // 工具
    N: v => parseFloat(String(v).replace(/,/g,'')) || 0,
    F: n => Math.round(n).toLocaleString('en-US'),

    init: () => {
        // 注入選單
        const opts = APP.ranks.map(r => `<option value="${r}">${r}</option>`).join('');
        document.getElementById('currentRank').innerHTML = opts;
        document.getElementById('targetRank').innerHTML = opts;

        // 初始化 A/B 預設值
        const def = {
            cRank:'少尉', tRank:'中校', years:20, realPay:0,
            living:15000, fixed:5000, 
            rate:30, roi:6, inf:2,
            buyHouse:false, buyY:10, hPrice:1200, down:20, loanY:30,
            listAllow: [], listExp: [], listInv: []
        };
        APP.store.A = JSON.parse(JSON.stringify(def));
        APP.store.B = JSON.parse(JSON.stringify(def));
        APP.store.B.roi = 1.5; APP.store.B.rate = 10; // B 案預設不同

        // 載入 A 案
        APP.loadToUI('A');
        
        // 啟動計算
        APP.update();
    },

    // --- 介面操作 ---
    switchTab: (tab) => {
        APP.saveFromUI(APP.currentTab); // 存當前
        APP.currentTab = tab;
        
        // UI 切換
        document.getElementById('tab-A').className = tab==='A' ? 'tab active' : 'tab';
        document.getElementById('tab-B').className = tab==='B' ? 'tab active' : 'tab';
        
        APP.loadToUI(tab); // 讀新分頁
        APP.update();
    },

    // 從 UI 讀取資料存入 Store
    saveFromUI: (tab) => {
        const d = APP.store[tab];
        d.cRank = document.getElementById('currentRank').value;
        d.tRank = document.getElementById('targetRank').value;
        d.years = APP.N(document.getElementById('years').value);
        d.realPay = APP.N(document.getElementById('realPay').value);
        
        d.living = APP.N(document.getElementById('livingCost').value);
        d.fixed = APP.N(document.getElementById('fixedCost').value);
        
        d.rate = APP.N(document.getElementById('investRate').value);
        d.roi = APP.N(document.getElementById('roi').value);
        d.inf = APP.N(document.getElementById('inflation').value);
        
        d.buyHouse = document.getElementById('buyHouse').checked;
        d.buyY = APP.N(document.getElementById('buyYear').value);
        d.hPrice = APP.N(document.getElementById('housePrice').value);
        d.down = APP.N(document.getElementById('downPayment').value);
        d.loanY = APP.N(document.getElementById('loanYears').value);

        // 讀取列表
        d.listAllow = APP.readList('list-allowance');
        d.listExp = APP.readList('list-expense');
        d.listInv = APP.readList('list-invest');
    },

    // 將 Store 資料填回 UI
    loadToUI: (tab) => {
        const d = APP.store[tab];
        document.getElementById('currentRank').value = d.cRank;
        document.getElementById('targetRank').value = d.tRank;
        document.getElementById('years').value = d.years;
        document.getElementById('realPay').value = d.realPay;
        
        document.getElementById('livingCost').value = d.living;
        document.getElementById('fixedCost').value = d.fixed;
        
        document.getElementById('investRate').value = d.rate;
        document.getElementById('rateLabel').innerText = d.rate + '%';
        document.getElementById('roi').value = d.roi;
        document.getElementById('inflation').value = d.inf;
        
        document.getElementById('buyHouse').checked = d.buyHouse;
        document.getElementById('housing-area').className = d.buyHouse ? 'space-y-2 text-sm' : 'hidden';
        document.getElementById('buyYear').value = d.buyY;
        document.getElementById('housePrice').value = d.hPrice;
        document.getElementById('downPayment').value = d.down;
        document.getElementById('loanYears').value = d.loanY;

        // 回填列表
        APP.renderList('list-allowance', d.listAllow);
        APP.renderList('list-expense', d.listExp);
        APP.renderList('list-invest', d.listInv);
    },

    // --- 列表邏輯 ---
    add: (id) => {
        const c = document.getElementById(id);
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `
            <input type="text" class="border p-1 text-sm rounded flex-1" value="項目">
            <input type="number" class="border p-1 text-sm rounded w-20 text-right" value="0" oninput="APP.update()">
            <div class="btn-del" onclick="this.parentElement.remove(); APP.update()">✕</div>
        `;
        c.appendChild(div);
        APP.update(); // 新增後立即運算
    },
    
    renderList: (id, list) => {
        const c = document.getElementById(id); c.innerHTML = '';
        list.forEach(i => {
            const div = document.createElement('div');
            div.className = 'item-row';
            div.innerHTML = `
                <input type="text" class="border p-1 text-sm rounded flex-1" value="${i.n}">
                <input type="number" class="border p-1 text-sm rounded w-20 text-right" value="${i.v}" oninput="APP.update()">
                <div class="btn-del" onclick="this.parentElement.remove(); APP.update()">✕</div>
            `;
            c.appendChild(div);
        });
    },

    readList: (id) => {
        const arr = [];
        document.getElementById(id).querySelectorAll('.item-row').forEach(row => {
            const inputs = row.querySelectorAll('input');
            arr.push({ n: inputs[0].value, v: APP.N(inputs[1].value) });
        });
        return arr;
    },

    // --- 核心運算 (每次 UI 變動直接觸發) ---
    calculateScenario: (d) => {
        // 解構參數
        const years = d.years || 20;
        const inflation = d.inf / 100;
        const roi = d.roi / 100;
        const investPct = d.rate / 100;
        
        let rank = d.cRank;
        let inv = 0, cash = 0, house = 0, loan = 0, hasHouse = false;
        
        const rankIdx = APP.ranks.indexOf(rank);
        const targetIdx = APP.ranks.indexOf(d.tRank);
        let currentRankIdx = rankIdx;
        let yearInRank = 0;

        // 計算列表總和
        const sumAllow = d.listAllow.reduce((a,b)=>a+b.v,0);
        const sumExp = d.listExp.reduce((a,b)=>a+b.v,0) + d.living + d.fixed;
        const sumInv = d.listInv.reduce((a,b)=>a+b.v,0);

        const res = { years:[], net:[], inv:[], cash:[], house:[], logs:[] };

        for(let y=1; y<=years; y++) {
            // 晉升 (簡易版：每4年升，直到目標)
            if (y > 1 && y % 4 === 0 && currentRankIdx < targetIdx) {
                currentRankIdx++; yearInRank = 0;
            } else yearInRank++;
            
            const rName = APP.ranks[currentRankIdx];
            const rInfo = APP.rankData[rName];

            // 收入計算
            let monthPay = 0;
            if (d.realPay > 0) {
                // 實領校正模式：假設隨年資每年微幅成長 1.5%
                monthPay = d.realPay * Math.pow(1.015, y-1); 
            } else {
                // 資料庫模式：本俸(年資成長) + 專業 + 列表加給 + 1.5萬志願役
                const base = rInfo.b * Math.pow(1.015, yearInRank);
                monthPay = base + rInfo.p + 15000 + sumAllow;
            }
            const annualInc = monthPay * 13.5;

            // 房貸
            let mortPay = 0;
            if (d.buyHouse && y === d.buyY && !hasHouse) {
                hasHouse = true; house = d.hPrice * 10000;
                const down = house * (d.down/100);
                loan = house - down;
                // 付頭期
                if(cash >= down) cash -= down;
                else { inv -= (down-cash); cash = 0; }
            }
            if (hasHouse && loan > 0) {
                // 本息均攤
                const r = 0.022/12, n = d.loanY*12; // 寫死利率 2.2% 簡化
                const pmt = loan * r * Math.pow(1+r, n) / (Math.pow(1+r, n) - 1);
                mortPay = pmt * 12;
                loan -= (mortPay - loan*0.022); // 簡扣本金
                if(loan<0) loan=0;
            }

            // 收支
            const annualExp = sumExp * 12 * Math.pow(1+inflation, y-1);
            const annualInv = (monthPay * investPct * 12) + (sumInv * 12);
            const surplus = annualInc - annualExp - annualInv - mortPay;

            // 滾存
            inv = inv * (1+roi) + annualInv;
            cash += surplus;
            const houseNet = hasHouse ? Math.max(0, house-loan) : 0;
            const net = inv + cash + houseNet;

            res.years.push(y); res.net.push(net); res.inv.push(inv); res.cash.push(cash); res.house.push(houseNet);
            res.logs.push({ y, rank: rName, inc: annualInc, exp: annualExp, inv: annualInv, mort: mortPay, net });
        }
        return res;
    },

    // 主更新入口
    update: () => {
        // 1. 抓當前 UI 數據存入 store[currentTab]
        APP.saveFromUI(APP.currentTab);
        
        // 2. 分別計算 A/B
        const rA = APP.calculateScenario(APP.store.A);
        const rB = APP.calculateScenario(APP.store.B);
        
        // 3. 顯示 KPI
        const lastA = rA.net.length-1;
        const lastB = rB.net.length-1;
        document.getElementById('kpi-A').innerText = APP.F(rA.net[lastA]);
        document.getElementById('kpi-B').innerText = APP.F(rB.net[lastB]);
        const diff = rA.net[lastA] - rB.net[lastB];
        document.getElementById('kpi-diff').innerText = (diff>=0?'+':'') + APP.F(diff);
        
        // 4. 畫圖
        APP.drawCharts(rA, rB);
        
        // 5. 畫表 (只畫當前 Tab)
        const currR = APP.currentTab === 'A' ? rA : rB;
        const tb = document.getElementById('table-body'); tb.innerHTML = '';
        currR.logs.forEach(r => {
            tb.innerHTML += `<tr>
                <td class="p-2 border-b text-center text-gray-500">Y${r.y}</td>
                <td class="p-2 border-b font-bold">${r.rank}</td>
                <td class="p-2 border-b text-right text-blue-600">${APP.F(r.inc)}</td>
                <td class="p-2 border-b text-right text-red-500">${APP.F(r.exp)}</td>
                <td class="p-2 border-b text-right text-green-600">${APP.F(r.inv)}</td>
                <td class="p-2 border-b text-right text-orange-500">${APP.F(r.mort)}</td>
                <td class="p-2 border-b text-right font-black">${APP.F(r.net)}</td>
            </tr>`;
        });
        
        // 控制購屋區塊顯示
        const buy = document.getElementById('buyHouse').checked;
        document.getElementById('housing-area').className = buy ? 'space-y-2 text-sm mt-2' : 'hidden';
    },

    drawCharts: (rA, rB) => {
        const labels = rA.years.map(y => 'Y'+y);
        const currR = APP.currentTab === 'A' ? rA : rB;

        // 資產對照
        if(APP.charts.asset) APP.charts.asset.destroy();
        APP.charts.asset = new Chart(document.getElementById('chart-asset'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: '方案 A', data: rA.net, borderColor: '#2563eb', borderWidth: 3, tension: 0.3 },
                    { label: '方案 B', data: rB.net, borderColor: '#94a3b8', borderWidth: 2, borderDash: [5,5] }
                ]
            }, options: { responsive: true, maintainAspectRatio: false }
        });

        // 資產結構
        if(APP.charts.wealth) APP.charts.wealth.destroy();
        APP.charts.wealth = new Chart(document.getElementById('chart-wealth'), {
            type: 'bar',
            data: {
                labels: currR.years.map(y=>'Y'+y),
                datasets: [
                    { label: '投資', data: currR.inv, backgroundColor: '#10b981', stack: '1' },
                    { label: '現金', data: currR.cash, backgroundColor: '#3b82f6', stack: '1' },
                    { label: '房產', data: currR.house, backgroundColor: '#f97316', stack: '1' }
                ]
            }, options: { responsive: true, maintainAspectRatio: false }
        });
    }
};

window.onload = APP.init;
</script>
</body>
</html>
