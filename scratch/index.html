<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國軍財務戰情室 v28.0 (論文實證版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #38bdf8; --danger: #f43f5e; --success: #10b981; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); color: #cbd5e1; height: 100vh; overflow: hidden; display: flex; margin: 0; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        aside { width: 380px; background: #0b1121; border-right: 1px solid #1e293b; display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; }
        .input-group { background: var(--panel); padding: 12px; border-radius: 8px; border: 1px solid #334155; margin-bottom: 10px; }
        label { font-size: 0.75rem; color: #94a3b8; display: block; margin-bottom: 4px; font-weight: 700; }
        input, select { background: #0f172a; border: 1px solid #334155; color: white; padding: 6px; border-radius: 4px; width: 100%; font-family: 'JetBrains Mono'; font-size: 0.85rem; }
        
        .btn-case { flex: 1; font-size: 0.7rem; padding: 6px 2px; border-radius: 4px; border: 1px solid #475569; background: #0f172a; color: #94a3b8; cursor: pointer; transition: 0.2s; text-align: center; }
        .btn-case:hover { background: #334155; color: white; }
        .btn-case.active { background: var(--accent); color: #0f172a; font-weight: bold; border-color: var(--accent); }

        main { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .kpi-card { background: rgba(30, 41, 59, 0.5); border-left: 4px solid #334155; padding: 15px; border-radius: 6px; }
        .chart-container { height: 280px; background: rgba(30, 41, 59, 0.3); border-radius: 8px; padding: 10px; margin-bottom: 15px; border: 1px solid #334155; }
        
        /* 表格 */
        .data-table { width: 100%; font-size: 0.75rem; border-collapse: collapse; }
        .data-table th { text-align: right; padding: 8px; color: #64748b; border-bottom: 1px solid #334155; }
        .data-table td { text-align: right; padding: 8px; border-bottom: 1px solid #1e293b; font-family: 'JetBrains Mono'; }
        
        #budget-alert { padding: 8px; margin-bottom: 10px; border-radius: 6px; font-weight: bold; font-size: 0.85rem; text-align: center; display: none; }
    </style>
</head>
<body>

<aside>
    <div class="p-4 border-b border-slate-800 bg-slate-950">
        <h1 class="text-lg font-bold text-white">財務戰情室 <span class="text-xs text-amber-500">v28.0 論文版</span></h1>
    </div>

    <div class="p-4">
        <div class="mb-4">
            <label class="text-amber-400 mb-2">THESIS SCENARIOS // 案例模擬</label>
            <div class="flex gap-1">
                <button class="btn-case" onclick="APP.loadCase(1)">C1<br>大成功</button>
                <button class="btn-case" onclick="APP.loadCase(2)">C2<br>小成功</button>
                <button class="btn-case" onclick="APP.loadCase(3)">C3<br>小失敗</button>
                <button class="btn-case" onclick="APP.loadCase(4)">C4<br>大失敗</button>
            </div>
        </div>

        <div class="input-group">
            <label class="text-cyan-400">CAREER</label>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <select id="currentRank" onchange="APP.update()"></select>
                <select id="targetRank" onchange="APP.update()"></select>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div><label>服役年</label><input type="number" id="years" value="20" oninput="APP.update()"></div>
                <div><label>實領校正</label><input type="number" id="realPay" value="0" oninput="APP.update()"></div>
            </div>
        </div>

        <div class="input-group">
            <label class="text-rose-400">FINANCE</label>
            <div class="flex justify-between mb-1"><span class="text-xs">支出比(%)</span><span id="livingPctLabel" class="text-xs text-white">50%</span></div>
            <input type="range" id="livingPct" min="10" max="95" value="50" oninput="APP.updateInput('livingPct')">
            
            <div class="flex justify-between mb-1 mt-2"><span class="text-xs">投資比(%)</span><span id="investRateLabel" class="text-xs text-white">30%</span></div>
            <input type="range" id="investRate" min="0" max="80" value="30" oninput="APP.updateInput('investRate')">

            <div class="grid grid-cols-2 gap-2 mt-2">
                <div><label>年報酬(%)</label><input type="number" id="roi" value="6.0" oninput="APP.update()"></div>
                <div><label>通膨率(%)</label><input type="number" id="inflation" value="2.0" oninput="APP.update()"></div>
            </div>
        </div>

        <div class="input-group">
            <div class="flex justify-between items-center mb-2">
                <label class="mb-0 text-orange-400">REAL ESTATE</label>
                <input type="checkbox" id="buyHouse" class="w-4 h-4" onchange="APP.update()">
            </div>
            <div id="housing-area" class="hidden grid grid-cols-2 gap-2">
                <input type="number" id="buyYear" value="5" placeholder="第N年買">
                <input type="number" id="housePrice" value="1200" placeholder="總價(萬)">
                <input type="number" id="downPayment" value="20" placeholder="頭期%">
                <input type="number" id="loanYears" value="30" placeholder="年限">
            </div>
        </div>
    </div>
</aside>

<main>
    <div id="budget-alert"></div>

    <div class="grid grid-cols-3 gap-4 mb-4">
        <div class="kpi-card" style="border-color: #38bdf8;">
            <div class="text-xs text-slate-400 mb-1">Y20 退伍淨資產</div>
            <div class="kpi-val text-cyan-400" id="kpi-net20">--</div>
        </div>
        <div class="kpi-card" style="border-color: #f59e0b;">
            <div class="text-xs text-slate-400 mb-1">80歲 資產推估 (實質)</div>
            <div class="kpi-val text-amber-400" id="kpi-net80">--</div>
            <div class="text-[10px] text-slate-500 mt-1">依據 5.x 章節通膨模型推算</div>
        </div>
        <div class="kpi-card" style="border-color: #f43f5e;">
            <div class="text-xs text-slate-400 mb-1">最大房貸負擔率</div>
            <div class="kpi-val text-rose-400" id="kpi-mortgage">--</div>
            <div class="text-[10px] text-slate-500 mt-1">壓力測試指標</div>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
        <div class="chart-container">
            <canvas id="chart-asset"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="chart-wealth"></canvas>
        </div>
    </div>

    <div class="flex-1 overflow-auto bg-slate-900/50 rounded border border-slate-800">
        <table class="data-table">
            <thead class="bg-slate-900 sticky top-0">
                <tr>
                    <th style="text-align:center">Y</th>
                    <th style="text-align:left">階級</th>
                    <th>年總收</th>
                    <th>年總支</th>
                    <th>投資額</th>
                    <th>房貸</th>
                    <th>淨資產</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</main>

<script>
/**
 * 國軍財務戰情室 v28.0 (論文實證版)
 * 核心新增：
 * 1. loadCase(): 快速載入 Case 1-4 參數。
 * 2. projectAge80(): 推算 80 歲資產。
 * 3. mortgageStress(): 計算房貸負擔率。
 */
Chart.defaults.color = '#64748b';
Chart.defaults.borderColor = '#1e293b';

const APP = {
    // 薪資 (本俸+專業)
    rankData: {
        '二兵': {b:10550, p:0}, '一兵': {b:11130, p:0}, '上兵': {b:12280, p:0},
        '下士': {b:14645, p:5500}, '中士': {b:16585, p:6200}, '上士': {b:18525, p:7000},
        '三等士官長': {b:22750, p:8200}, '二等士官長': {b:25050, p:9500}, '一等士官長': {b:28880, p:10800},
        '少尉': {b:22750, p:8500}, '中尉': {b:25050, p:9800}, '上尉': {b:28880, p:11500},
        '少校': {b:32710, p:23000}, '中校': {b:37310, p:26000}, '上校': {b:41900, p:32000}
    },
    ranks: ['二兵','一兵','上兵','下士','中士','上士','三等士官長','二等士官長','一等士官長','少尉','中尉','上尉','少校','中校','上校'],
    
    charts: {},

    // 工具
    N: v => parseFloat(String(v).replace(/,/g,'')) || 0,
    F: n => Math.round(n).toLocaleString('en-US'),

    init: () => {
        const opts = APP.ranks.map(r => `<option value="${r}">${r}</option>`).join('');
        document.getElementById('currentRank').innerHTML = opts;
        document.getElementById('targetRank').innerHTML = opts;
        APP.loadCase(1); // 預設載入案例一
    },

    updateInput: (id) => {
        document.getElementById(id + 'Label').innerText = document.getElementById(id).value + '%';
        APP.update();
    },

    // --- 論文案例載入器 (Case Loader) ---
    loadCase: (id) => {
        // 重置按鈕樣式
        document.querySelectorAll('.btn-case').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.btn-case')[id-1].classList.add('active');

        // 定義案例參數 (依據論文 5.2 - 5.5)
        let p = {};
        if (id === 1) { // 案例一：大成功 (積極投資+早期置產)
            p = { cRank:'少尉', tRank:'上校', years:20, living:50, rate:30, roi:8.0, buy:true, bY:5, hP:1200, down:20 };
        } else if (id === 2) { // 案例二：小成功 (穩健+租屋)
            p = { cRank:'少尉', tRank:'中校', years:20, living:65, rate:15, roi:4.5, buy:false, bY:0, hP:0, down:0 }; 
            // 註：living 65% 包含租金
        } else if (id === 3) { // 案例三：小失敗 (保守+通膨)
            p = { cRank:'少尉', tRank:'少校', years:20, living:85, rate:5, roi:1.5, buy:false, bY:0, hP:0, down:0 };
        } else if (id === 4) { // 案例四：大失敗 (高負債)
            p = { cRank:'少尉', tRank:'少校', years:20, living:40, rate:0, roi:0, buy:true, bY:1, hP:1500, down:10 };
            // 註：高價房產 + 買太早 + 低頭期 = 災難
        }

        // 填入 UI
        document.getElementById('currentRank').value = p.cRank;
        document.getElementById('targetRank').value = p.tRank;
        document.getElementById('years').value = p.years;
        document.getElementById('livingPct').value = p.living;
        document.getElementById('investRate').value = p.rate;
        document.getElementById('roi').value = p.roi;
        document.getElementById('buyHouse').checked = p.buy;
        
        if (p.buy) {
            document.getElementById('buyYear').value = p.bY;
            document.getElementById('housePrice').value = p.hP;
            document.getElementById('downPayment').value = p.down;
        }

        APP.updateInput('livingPct');
        APP.updateInput('investRate');
    },

    // --- 核心運算 ---
    update: () => {
        // 1. 讀取 UI
        const d = {
            cRank: document.getElementById('currentRank').value,
            tRank: document.getElementById('targetRank').value,
            years: APP.N(document.getElementById('years').value),
            livingPct: APP.N(document.getElementById('livingPct').value),
            rate: APP.N(document.getElementById('investRate').value),
            roi: APP.N(document.getElementById('roi').value),
            inf: APP.N(document.getElementById('inflation').value),
            buyHouse: document.getElementById('buyHouse').checked,
            buyY: APP.N(document.getElementById('buyYear').value),
            hPrice: APP.N(document.getElementById('housePrice').value),
            down: APP.N(document.getElementById('downPayment').value),
            loanY: APP.N(document.getElementById('loanYears').value),
            realPay: APP.N(document.getElementById('realPay').value)
        };

        // 2. 執行運算
        let inv = 0, cash = 0, hasHouse = false, houseVal = 0, loan = 0;
        let cIdx = APP.ranks.indexOf(d.cRank);
        let tIdx = APP.ranks.indexOf(d.tRank);
        let yrInR = 0;
        let maxMortgageRatio = 0;
        let hasError = false;

        const res = { years:[], net:[], inv:[], cash:[], house:[], logs:[] };

        for(let y=1; y<=d.years; y++) {
            if (y > 1 && y % 4 === 0 && cIdx < tIdx) { cIdx++; yrInR = 0; } else yrInR++;
            let rName = APP.ranks[cIdx];
            const rInfo = APP.rankData[rName];

            // 收入
            let mPay = d.realPay > 0 ? d.realPay * Math.pow(1.015, y-1) : (rInfo.b * Math.pow(1.015, yrInR) + rInfo.p + 15000);
            let aInc = mPay * 13.5;

            // 退伍金 (20年)
            if (y === d.years && d.years >= 20) {
                const pension = mPay * (100 + cIdx * 5) * 0.45;
                aInc += pension;
                rName += " (退伍)";
            }

            // 支出 (通膨)
            const creep = 1 + (cIdx * 0.03);
            const aExp = (mPay * (d.livingPct/100) * creep + 5000) * 12 * Math.pow(1 + d.inf/100, y-1);

            // 房產
            let mort = 0, downPay = 0;
            if (d.buyHouse && y === d.buyY && !hasHouse) {
                hasHouse = true; houseVal = d.hPrice * 10000;
                downPay = houseVal * (d.down/100);
                loan = houseVal - downPay;
                if (cash >= downPay) cash -= downPay; else { inv -= (downPay - cash); cash = 0; }
            }
            if (hasHouse && loan > 0) {
                const r = 0.022/12, n = d.loanY * 12;
                const pmt = loan * r * Math.pow(1+r, n) / (Math.pow(1+r, n) - 1);
                mort = pmt * 12;
                loan -= (mort - loan * 0.022);
                
                // 記錄最大房貸負擔率
                const ratio = (pmt / mPay) * 100;
                if (ratio > maxMortgageRatio) maxMortgageRatio = ratio;
            }

            const aInv = (mPay * (d.rate / 100) * 12);
            
            // 紅字判定
            if ((aExp + aInv + mort + downPay) > aInc && (cash + inv + aInc - aExp - aInv - mort - downPay) < 0) hasError = true;

            const surplus = aInc - aExp - aInv - mort;
            inv = inv * (1 + d.roi/100) + aInv;
            cash += surplus;
            const hNet = hasHouse ? Math.max(0, houseVal - loan) : 0;
            const net = inv + cash + hNet;

            res.years.push(y); res.net.push(net); res.inv.push(inv); res.cash.push(cash); res.house.push(hNet);
            res.logs.push({ y, rank: rName, inc: aInc, exp: aExp, inv: aInv, mort: mort+downPay, net });
        }

        // 3. 顯示結果
        const net20 = res.net[res.net.length-1];
        document.getElementById('kpi-net20').innerText = APP.F(net20);
        
        // 80歲推估 (Assuming retires at 42, so 38 more years)
        // 實質報酬率 = (1+名目)/(1+通膨) - 1
        const realRoi = (1 + d.roi/100) / (1 + d.inf/100) - 1;
        const yearsTo80 = 38;
        // 假設退伍後資產以實質報酬率滾動 (不考慮退伍後工作收入，純看資產力)
        const net80 = net20 * Math.pow(1 + realRoi, yearsTo80);
        document.getElementById('kpi-net80').innerText = APP.F(net80);

        // 房貸警示
        const kpiMort = document.getElementById('kpi-mortgage');
        kpiMort.innerText = maxMortgageRatio.toFixed(1) + '%';
        kpiMort.className = maxMortgageRatio > 50 ? "kpi-val text-rose-500 animate-pulse" : "kpi-val text-emerald-400";

        // 預算警示
        const alertBox = document.getElementById('budget-alert');
        if (hasError || maxMortgageRatio > 60) {
            alertBox.style.display = 'block';
            alertBox.style.backgroundColor = 'rgba(244, 63, 94, 0.2)';
            alertBox.style.color = '#f43f5e';
            alertBox.innerText = "⚠️ 風險警告：房貸負擔過重或出現財務赤字 (符合案例四特徵)";
        } else {
            alertBox.style.display = 'block';
            alertBox.style.backgroundColor = 'rgba(16, 185, 129, 0.2)';
            alertBox.style.color = '#10b981';
            alertBox.innerText = "✅ 財務健康：通過壓力測試";
        }

        APP.drawCharts(res);
        APP.renderTable(res);
        
        document.getElementById('housing-area').className = d.buyHouse ? 'grid grid-cols-2 gap-2' : 'hidden';
    },

    drawCharts: (r) => {
        const labels = r.years.map(y => 'Y'+y);
        
        if(APP.charts.asset) APP.charts.asset.destroy();
        APP.charts.asset = new Chart(document.getElementById('chart-asset'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ label: '淨資產成長', data: r.net, borderColor: '#38bdf8', borderWidth:3, tension:0.4, fill:true, backgroundColor:'rgba(56, 189, 248, 0.1)' }]
            }, options: { responsive:true, maintainAspectRatio:false }
        });

        if(APP.charts.wealth) APP.charts.wealth.destroy();
        APP.charts.wealth = new Chart(document.getElementById('chart-wealth'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: '金融資產', data: r.inv, backgroundColor: '#10b981' },
                    { label: '現金', data: r.cash, backgroundColor: '#3b82f6' },
                    { label: '房產淨值', data: r.house, backgroundColor: '#f97316' }
                ]
            }, options: { responsive:true, maintainAspectRatio:false, scales: { x:{stacked:true}, y:{stacked:true} } }
        });
    },

    renderTable: (r) => {
        const tb = document.getElementById('table-body'); tb.innerHTML = '';
        r.logs.forEach(l => {
            tb.innerHTML += `<tr>
                <td style="text-align:center">Y${l.y}</td>
                <td style="text-align:left; font-weight:bold">${l.rank}</td>
                <td style="color:#38bdf8">${APP.F(l.inc)}</td>
                <td style="color:#f43f5e">${APP.F(l.exp)}</td>
                <td style="color:#10b981">${APP.F(l.inv)}</td>
                <td style="color:#f59e0b">${APP.F(l.mort)}</td>
                <td style="color:#fff; font-weight:bold">${APP.F(l.net)}</td>
            </tr>`;
        });
    }
};

window.onload = APP.init;
</script>
</body>
</html>
